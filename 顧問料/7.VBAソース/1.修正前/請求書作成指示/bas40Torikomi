Attribute VB_Name = "bas40Torikomi"
Option Explicit

Const MODULE_NAME = "bas40Torikomi"

'Public lngErrorCnt  As Long

'口座構造体
Public Type typKohzaMain
    strOyaKohzaNo       As String   '(親)口座NO     ※親無しは子口座番号
    GassanTaishohKbn    As Long     '合算対象区分(1:合算対象　0:合算対象ではない)
    dicOutPutShorui()   As Variant  '作成書類
    strKohzaList()      As String   '口座情報一覧
End Type
 

'資産コード構造体
Public Type typSisanCode
    SisanCode       As String       '資産コード
    lngSisanCnt     As Long         '配列Sisanの添字(インデックス)
End Type

'料率変更構造体
Public Type RateChange
    strKeisanHohhoh         As String   '顧問料計算方法
    strKisoKeisanHohhoh     As String   '基礎数値計算方法
    SisanCode()             As typSisanCode   '資産コード構造体(配列)
End Type

Public Type TorikomiOutput
    RyouHen()           As RateChange   '料率変更構造体
    lngChoseSisanId     As Long         '(インクリメント)調整資産ID
    lngJikoSeteiId      As Long         '(インクリメント)自己設定ID
    Sisan()             As Variant      '資産(料率適用期間テーブルの内容)
End Type


'調整資産数構造体　※（計算期間X）の作成用
Private Type typChoseiSisanNum
    strSisanBunrui          As String   '調整資産分類
    strSisanCode            As String   '調整資産コード
    lngKikan                As Long     '期間番号
End Type

'------------<Modify Start azuma 2006/12/20 (PH2)> -----------------------
'最低保障結果構造体
Public Type TypSaitei
    strSaiteYukouFlg        As String   '最低保障有効(0:無効、1:有効)
    valKomonryohGaku        As Variant  '資産全体の顧問料額
    valHoshohGaku           As Variant  '最低保障額
End Type

'口座属性取得構造体
Public Type TypKohzaZokuse
'    kohza_no                As String
'    anbun_hohhoh            As String
'    saitei_hoshoh_gaku      As String
'    rate_kohjyo_kbn         As String
'    rate_kohjyo_wariai      As String
'    gassan_taishoh_kbn      As String
'    t21_enchoh_kbn          As String
    seikoh_hohshu_kbn       As String
    seikoh_hohshu_type      As String
    anbun_hohhoh            As String
'------------<Modify Start azuma 2007/02/14 > -----------------------
    kami_mishu_kakeme_rate  As String
'------------<Modify End   azuma 2007/02/14 > -----------------------
End Type
'------------<Modify End   azuma 2006/12/20 (PH2)> -----------------------


'------------<Modify Start azuma 2006/10/25 連No.54> -----------------------
''''作成書類一覧(案内用)構造体
'''Public Type typShorui
'''    strKhozaNo              As String   '口座番号
'''    lngListCnt              As Long     '作成書類数
'''    strShoruiList()         As Variant  '作成書類
'''End Type
'''
'''Public typSakuseiSyorui()   As typShorui
'''Public dicShoruiList        As Variant
'------------<Modify End   azuma 2006/10/25 連No.54> -----------------------



''データシートのテンプレートシート名

'*************************************************************************
'関数名　　：取込処理メイン
'
'引　　数　：
'           lngKohzaCnt       I       処理対象の配列インデックス(親口座)
'           strKohzaList      I       処理対象の配列
'           strOutputDir      I       出力先フォルダ
'           strFileName       I       データファイル名(Pathなし)
'           strNamInfo        I       NAM情報
'           typTorikomi       O       料率変更構造体
'           lngErrorCnt       O       エラー数
'
'戻り値　　：
'
'機能説明　：
'
'更新履歴　：2006/07/31 SRA Y.Azuma    新規作成
'更新履歴　：2007/03/29 SRA Y.Azuma    変更     (PH3)断面系口座情報取得
'
'*************************************************************************
Public Function func_TorikomiMain(ByVal lngKohzaCnt As Long _
                                , ByRef typKohzaList() As typKohzaMain _
                                , ByVal strOutputDir As String _
                                , ByVal strFileName As String _
                                , ByRef strNamInfo() As String _
                                , ByRef typTorikomi As TorikomiOutput _
                                , ByRef lngErrorCnt As Long) As Boolean
On Error GoTo ErrHandler

    Const PROCEDURE_NAME = "func_TorikomiMain"
    Dim blnRet          As Boolean
    
    Dim strKohzaNo      As String       '(検索条件)口座番号
    Dim lngKikanId      As Long         '(検索条件)請求期間ID
    Dim strSeikyuTo     As String       '(検索条件)請求書期間To
    Dim SisanOya()      As Variant      '検索結果の配列(料率適用期間テーブル)(親口座)
    Dim Sisan()         As Variant      '検索結果の配列(料率適用期間テーブル)(子口座)
    Dim lngSisanOyaCnt  As Long         '検索結果の行数
    Dim lngSisanCnt     As Long         '検索結果の行数
    Dim lngCnt          As Long
    
    Dim lngKKCnt        As Long         '子口座のカウント
'    Dim dicOutList      As Variant      '作成した書類一覧Dic
    
    Dim lngEndRows      As Long
    
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
    Dim strSeikyuFrom   As String       '請求書期間From
    Dim strHeiDanKbn    As String       '平残断面区分
    Dim strMaeAtoPayKbn As String       '前払後払区分
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
    
    func_TorikomiMain = False

    blnRet = False
    
'------------<Modify Start azuma 2006/10/25 連No.54> -----------------------
'''    Set dicShoruiList = CreateObject("Scripting.Dictionary")
'------------<Modify End   azuma 2006/10/25 連No.54> -----------------------

'*******************************************************
'* 関数開始　                                        　*
'*******************************************************

    '1.2.2 請求対象の資産取得
'    Application.ScreenUpdating = False

    Workbooks(strFileName).Sheets.Add After:=Worksheets(DATASHEET_TEMP_DATA)
    Workbooks(strFileName).ActiveSheet.Name = DATASHEET_DATA        'シート名変更
    
    Workbooks(strFileName).Worksheets(DATASHEET_TEMP_DATA).Visible = False
    
'    Workbooks(strFileName).Worksheets(DATASHEET_DATA).Visible = False
    
    
'------------<Modify Start azuma 2006/10/25 連No.54> -----------------------
'''    ReDim Preserve typSakuseiSyorui(UBound(typKohzaList(lngKohzaCnt).strKohzaList))
'''    For lngCnt = 0 To UBound(typKohzaList(lngKohzaCnt).strKohzaList)
'''        With typSakuseiSyorui(lngCnt)
'''            .lngListCnt = -1
'''            Erase .strShoruiList
'''        End With
'''    Next lngCnt
'------------<Modify End   azuma 2006/10/25 連No.54> -----------------------
    
    
    '   検索条件項目設定
    '
    
    '****** 合算口座の場合 **************************************************************
    If typKohzaList(lngKohzaCnt).GassanTaishohKbn = KOHZA_GASSAN_ON Then
'Debug.Print typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_SEIKYUSHO_KIKAN_FROM)  '(検索条件)請求書期間From
'Debug.Print typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_HEIZAN_DANMEN_KBN)      '(検索条件)平残断面区分
'Debug.Print typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_MAE_ATO_BARAI_KBN)   '(検索条件)前払後払区分
    
        '(親口座分)料率適用期間テーブルから該当の資産を一覧で取得する。
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
        blnRet = func_GetTargetSisanInfoOya(typKohzaList(lngKohzaCnt).strOyaKohzaNo _
                                          , typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_SEIKYU_KIKAN_ID) _
                                          , typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_SEIKYUSHO_KIKAN_FROM) _
                                          , typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_SEIKYUSHO_KIKAN_TO) _
                                          , typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_HEIZAN_DANMEN_KBN) _
                                          , typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_MAE_ATO_BARAI_KBN) _
                                          , SisanOya _
                                          , lngSisanOyaCnt)
'        blnRet = func_GetTargetSisanInfoOya(typKohzaList(lngKohzaCnt).strOyaKohzaNo _
'                                          , typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_SEIKYU_KIKAN_ID) _
'                                          , SisanOya _
'                                          , lngSisanOyaCnt)
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
        If blnRet = False Then
            Exit Function
        Else
            '資産データが存在しない場合
            If lngSisanOyaCnt = 0 Then
'                MsgBox "資産データなし(func_GetTargetSisanInfoOya)"
                Call gfunc_ErrorMsg(3, 6400, "料率適用期間テーブル", "(func_GetTargetSisanInfoOya)")
                'エラー情報構造体セット
                With gusrErr
                    .ModuleId = MODULE_NAME         'モージュールID
                    .Procedure = PROCEDURE_NAME     'プロシージャID
                    .MsgCode = ERR_MSGCD_VB         'メッセージ区分
                    .ErrNum = Err.Number            'システムエラーコード
                    .ErrDescript = Err.Description  'システムエラー内容
                    .KohzaNo = typKohzaList(lngKohzaCnt).strOyaKohzaNo
                    .MsgNaiyou = "合算親口座資産データ０件"   'メッセージ内容(ブックファイル名)
                    .MsgSyousai = "合算親口座番号の資産データがありませんでした。" & vbCrLf & _
                                  "料率適用期間テーブルに該当レコードがあるか確認して下さい。" & vbCrLf & _
                                  "存在しない場合システム管理者に連絡して下さい。" & vbCrLf & _
                                  "テーブル　　　：KYK_RATE_TEKIYOH_KIKAN" & vbCrLf & _
                                  "口座番号　　　：" & typKohzaList(lngKohzaCnt).strOyaKohzaNo & vbCrLf & _
                                  "請求期間ＩＤ　：" & typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_SEIKYU_KIKAN_ID) & vbCrLf & _
                                  "請求書期間From：" & typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_SEIKYUSHO_KIKAN_FROM) & vbCrLf & _
                                  "請求書期間To　：" & typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_SEIKYUSHO_KIKAN_TO) & vbCrLf & _
                                  "平残断面区分　：" & typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_HEIZAN_DANMEN_KBN) & vbCrLf & _
                                  "前払後払区分　：" & typKohzaList(lngKohzaCnt).strKohzaList(0, KOHZALIST_MAE_ATO_BARAI_KBN) & vbCrLf
                                  'メッセージ詳細
                    
                    'エラーシート書き込み
                    
                    Call fncWriteErrSheet(ERROR_SHEETNAME)
                End With
                Exit Function
            End If
        End If
    
    

        For lngKKCnt = 1 To UBound(typKohzaList(lngKohzaCnt).strKohzaList)
        
            
'------------<Modify Start azuma 2006/10/25 連No.54> -----------------------
'''            With typSakuseiSyorui(lngKKCnt)
'''                '書類構造体に口座番号設定
'''                .strKhozaNo = typKohzaList(lngKohzaCnt).strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
'''            End With
'''            dicShoruiList.RemoveAll
'------------<Modify End   azuma 2006/10/25 連No.54> -----------------------
            
            'シートの最終行取得
            lngEndRows = func_GetEndRow(strFileName, DATASHEET_DATA)
            
        
            ' データファイルの資産数毎のカスタマイズ
            blnRet = False
            blnRet = func_DataFileCustomizeOya(SisanOya _
                                          , strOutputDir _
                                          , strFileName _
                                          , typKohzaList(lngKohzaCnt).strKohzaList _
                                          , lngKKCnt _
                                          , typKohzaList _
                                          , lngKohzaCnt _
                                          , typTorikomi _
                                          , lngErrorCnt)
            If blnRet = False Then
                GoTo FileClose
                Exit Function
            End If
        
            ' データファイルの行毎にデータ取得
            blnRet = False
            blnRet = func_CompleteDataFile(strFileName _
                                         , typKohzaList(lngKohzaCnt).strKohzaList _
                                         , lngKKCnt _
                                         , strNamInfo() _
                                         , typKohzaList _
                                         , lngKohzaCnt _
                                         , typTorikomi _
                                         , lngErrorCnt _
                                         , lngEndRows + 1)
            If blnRet = False Then
                GoTo FileClose
                Exit Function
            End If
        Next lngKKCnt
    
    End If
    '***********************************************************************************
        
    
    '****** 平残・合算口座の共有 *********************************************************
'    For lngKKCnt = 0 To UBound(typKohzaList(lngKohzaCnt).strKohzaList, 1)
    For lngKKCnt = 1 To UBound(typKohzaList(lngKohzaCnt).strKohzaList, 1)
        With typKohzaList(lngKohzaCnt)
            strKohzaNo = .strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)          '(検索条件)口座番号
            lngKikanId = .strKohzaList(lngKKCnt, KOHZALIST_SEIKYU_KIKAN_ID)   '(検索条件)請求期間ID
            strSeikyuTo = .strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_TO)  '(検索条件)請求書期間To
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
            strSeikyuFrom = .strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM) '(検索条件)請求書期間From
            strHeiDanKbn = .strKohzaList(lngKKCnt, KOHZALIST_HEIZAN_DANMEN_KBN)     '(検索条件)平残断面区分
            strMaeAtoPayKbn = .strKohzaList(lngKKCnt, KOHZALIST_MAE_ATO_BARAI_KBN)  '(検索条件)前払後払区分
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
        End With
        
    
'------------<Modify Start azuma 2006/10/25 連No.54> -----------------------
'''        With typSakuseiSyorui(lngKKCnt)
'''            '書類構造体に口座番号設定
'''            .strKhozaNo = typKohzaList(lngKohzaCnt).strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
'''        End With
'''        dicShoruiList.RemoveAll
'------------<Modify End   azuma 2006/10/25 連No.54> -----------------------
        
        'シートの最終行取得
        lngEndRows = func_GetEndRow(strFileName, DATASHEET_DATA)
        
        
        '(子口座分)組入資産、料率適用期間テーブルから該当の資産を一覧で取得する。
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
        blnRet = func_GetTargetSisanInfo(strKohzaNo _
                                       , lngKikanId _
                                       , strSeikyuFrom _
                                       , strSeikyuTo _
                                       , strHeiDanKbn _
                                       , strMaeAtoPayKbn _
                                       , Sisan _
                                       , lngSisanCnt)
'        blnRet = func_GetTargetSisanInfo(strKohzaNo _
'                                       , lngKikanId _
'                                       , strSeikyuTo _
'                                       , Sisan _
'                                       , lngSisanCnt)
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
        If blnRet = False Then
            Exit Function
        Else
            '資産データが存在しない場合
            If lngSisanCnt = 0 Then
                Call gfunc_ErrorMsg(3, 6410, "料率適用期間テーブル", "(func_GetTargetSisanInfo)")
                'エラー情報構造体セット
                With gusrErr
                    .ModuleId = MODULE_NAME         'モージュールID
                    .Procedure = PROCEDURE_NAME     'プロシージャID
                    .MsgCode = ERR_MSGCD_VB         'メッセージ区分
                    .ErrNum = Err.Number            'システムエラーコード
                    .ErrDescript = Err.Description  'システムエラー内容
                    .KohzaNo = strKohzaNo
                    .MsgNaiyou = "該当資産データなし"   'メッセージ内容
                    .MsgSyousai = "計算方法登録画面で資産を確認して下さい。" & vbCrLf & _
                                  "テーブル　　　：KYK_KUMIIRE_SHISAN,KYK_RATE_TEKIYOH_KIKAN" & vbCrLf & _
                                  "口座番号　　　：" & strKohzaNo & vbCrLf & _
                                  "請求期間ＩＤ　：" & lngKikanId & vbCrLf & _
                                  "請求期間ＴＯ　：" & strSeikyuTo & vbCrLf  'メッセージ詳細
                    
                    'エラーシート書き込み
                    
                    Call fncWriteErrSheet(ERROR_SHEETNAME)
                End With
                Exit Function
            End If
        End If
        
        typTorikomi.Sisan = Sisan
        
        
        '1.2.3 データファイルの資産数毎のカスタマイズ
        blnRet = False
        blnRet = func_DataFileCustomize(Sisan _
                                      , strOutputDir _
                                      , strFileName _
                                      , typKohzaList(lngKohzaCnt).strKohzaList _
                                      , lngKKCnt _
                                      , typKohzaList _
                                      , lngKohzaCnt _
                                      , SisanOya _
                                      , typTorikomi _
                                      , lngErrorCnt)
        If blnRet = False Then
            GoTo FileClose
            Exit Function
        End If
        
            
    
    

        ' データファイルの行毎にデータ取得
        blnRet = False
        blnRet = func_CompleteDataFile(strFileName _
                                     , typKohzaList(lngKohzaCnt).strKohzaList _
                                     , lngKKCnt _
                                     , strNamInfo() _
                                     , typKohzaList _
                                     , lngKohzaCnt _
                                     , typTorikomi _
                                     , lngErrorCnt _
                                     , lngEndRows + 1)
        If blnRet = False Then
            GoTo FileClose
            Exit Function
        End If
    Next lngKKCnt
    '***********************************************************************************

    
    Workbooks(strFileName).Worksheets(DATASHEET_DATA).Visible = True
    Workbooks(strFileName).Worksheets(DATASHEET_DATA).Select
    
    'データシートの行を並べ替える
    Call sub_SortDataSheet(strFileName)
    
    'データシートの元シートを削除する。
    ThisWorkbook.Application.DisplayAlerts = False
    Workbooks(strFileName).Worksheets(DATASHEET_TEMP_DATA).Delete
    ThisWorkbook.Application.DisplayAlerts = True


    'データファイルを保存して閉じる
    Workbooks(strFileName).Close savechanges:=True

    Erase Sisan
    Erase SisanOya

    func_TorikomiMain = True
    Exit Function
    
FileClose:
    ThisWorkbook.Application.DisplayAlerts = False
    'データファイルを保存して閉じる
    Workbooks(strFileName).Close savechanges:=True
'    Application.ScreenUpdating = True
    
    Erase Sisan
    Erase SisanOya
    
    Exit Function
    
ErrHandler:

    func_TorikomiMain = False
'Resume
'---- Error Log Start ----------------------------------------------------
    Dim lng As Long
    lng = Err.Number
    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "func_TorikomiMain", Err.Number, Err.Description)
    On Error GoTo 0
'    Err.Raise lng
'---- Error Log End   ----------------------------------------------------

    Erase Sisan
    Erase SisanOya


End Function


'*************************************************************************
'関数名　　：請求対象の資産取得関数
'
'引　　数　：
'           strKohzaNo      I       口座番号
'           lngKikanId      I       請求期間ID
'           strSeikyuFrom   I       請求書期間From(PH3)
'           strSeikyuTo     I       請求書期間To
'           strHeiDanKbn    I       平残断面区分(PH3)
'           strMaeAtoPayKbn I       前払後払区分(PH3)
'           Sisan           O       検索結果の配列
'           lngSisanCnt     O       検索結果の行数
'
'戻り値　　：Boolean
'
'機能説明　：料率適用期間テーブルから請求対象の資産一覧を取得する。
'
'更新履歴　：2006/07/31 SRA Y.Azuma    新規作成
'更新履歴　：2006/10/20 SRA Y.Azuma    変更     料率テーブル無しをシステムエラーにしない(単No.219)
'更新履歴　：2007/03/29 SRA Y.Azuma    変更     (PH3)断面系口座情報取得
'
'*************************************************************************
Private Function func_GetTargetSisanInfo(ByVal strKohzaNo As String _
                                        , ByVal lngKikanId As Long _
                                        , ByVal strSeikyuFrom As String _
                                        , ByVal strSeikyuTo As String _
                                        , ByVal strHeiDanKbn As String _
                                        , ByVal strMaeAtoPayKbn As String _
                                        , ByRef Sisan() As Variant _
                                        , ByRef lngSisanCnt As Long) As Boolean
On Error GoTo ErrHandler

    Dim strSql      As String
    Dim vdata()     As Variant
    Dim lngCol      As Long
    Dim lngRow      As Long
    Dim lngRowCnt   As Long
    Dim lngColCnt   As Long
    
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
    Const ItemMax = 9           '取得データの添え字最大値
'    Const ItemMax = 6           '取得データの添え字最大値
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------

    func_GetTargetSisanInfo = False
'*******************************************************
'* 関数開始　                                        　*
'*******************************************************


    strSql = ""
    strSql = strSql & " SELECT"
    strSql = strSql & "     A.SHISAN_BUNRUI ,"              ' 0:資産分類
    strSql = strSql & "     A.SHISAN_CODE ,"                ' 1:資産コード
    strSql = strSql & "     B.RATE_TEKIYOH_KIKAN_FROM ,"    ' 2:料率適用期間From
    strSql = strSql & "     B.RATE_TEKIYOH_KIKAN_TO ,"      ' 3:料率適用期間To
    strSql = strSql & "     B.RATE_TEKIYOH_KIKAN_ID ,"      ' 4:料率適用期間ID
    strSql = strSql & "     B.KEISAN_HOHHOH ,"              ' 5:計算方法
    strSql = strSql & "     B.KISO_SUCHI_KEISAN_HOHHOH"     ' 6:基礎数値計算方法
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
    strSql = strSql & "    ,B.SEIKYU_KIKAN_ID "             ' 7:請求期間ID(親口座と同じにする為)
    strSql = strSql & "    ,B.SEIKYUSHO_SHURUI "            ' 8:請求書種類
    strSql = strSql & "    ,B.RATE_CODE "                   ' 9:料率コード
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
    strSql = strSql & " FROM"
    strSql = strSql & "     KYK_KUMIIRE_SHISAN     A ,"
    strSql = strSql & "     KYK_RATE_TEKIYOH_KIKAN B"
    strSql = strSql & " WHERE"
    strSql = strSql & "     A.KOHZA_NO        = B.KOHZA_NO        AND"
    strSql = strSql & "     A.SEIKYU_KIKAN_ID = B.SEIKYU_KIKAN_ID AND"
    strSql = strSql & "     A.SHISAN_BUNRUI   = B.SHISAN_BUNRUI   AND"
    strSql = strSql & "     A.SHISAN_CODE     = B.SHISAN_CODE     AND"
    strSql = strSql & "     A.KOHZA_NO        = '" & strKohzaNo & "'         AND"
    strSql = strSql & "     A.SEIKYU_KIKAN_ID = " & lngKikanId & " And "
    
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
    '顧問料請求管理の平残断面区分が「断面」かつ前払後払区分が「前払」の場合(断面A又は時価断面)
    If strHeiDanKbn = DANMEN And strMaeAtoPayKbn = MAE_BARAI Then
        strSql = strSql & "     B.RATE_TEKIYOH_KIKAN_FROM = " & strSeikyuFrom
    Else
        strSql = strSql & "     B.RATE_TEKIYOH_KIKAN_FROM <= " & strSeikyuTo
    End If
'    strSql = strSql & "     B.RATE_TEKIYOH_KIKAN_FROM <= " & strSeikyuTo

    strSql = strSql & " AND A.SAKUJO_FLG      =  '0'"
    strSql = strSql & " AND B.SAKUJO_FLG      =  '0'"
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
    
    strSql = strSql & " ORDER BY"
    strSql = strSql & "     B.RATE_TEKIYOH_KIKAN_FROM,"
    strSql = strSql & "     B.RATE_TEKIYOH_KIKAN_TO,"
    strSql = strSql & "     A.SHISAN_BUNRUI ,"
    strSql = strSql & "     A.SHISAN_CODE "

    'データ取得
    Call gclsDB.DoExequteSql(gcSELECT, strSql, vdata, lngCol, lngRow)
    
    
    If lngRow = 0 Then
    'データなし
        Erase Sisan
        lngSisanCnt = 0
'------------<Modify Start azuma 2006/10/20 単No.219> -----------------------
        func_GetTargetSisanInfo = True
        'Exit Function
'------------<Modify End   azuma 2006/10/20 単No.219> -----------------------
    Else
    'データあり
        ReDim Sisan(lngRow - 1, ItemMax)
        lngSisanCnt = lngRow
        For lngRowCnt = 0 To lngRow - 1
            For lngColCnt = 0 To ItemMax
                Sisan(lngRowCnt, lngColCnt) = vdata(lngColCnt, lngRowCnt)
            Next lngColCnt
        Next lngRowCnt
    End If

    Erase vdata

    func_GetTargetSisanInfo = True
    Exit Function

ErrHandler:

    func_GetTargetSisanInfo = False
'Debug.Print strSql
'---- Error Log Start ----------------------------------------------------
    Dim lng As Long
    lng = Err.Number
    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "func_GetTargetSisanInfo", Err.Number, Err.Description)
    On Error GoTo 0
'    Err.Raise lng
'---- Error Log End   ----------------------------------------------------

    Erase vdata
    
End Function

'*************************************************************************
'関数名　　：請求対象合算親口座のデータ取得関数
'
'引　　数　：
'           strKohzaNo      I       口座番号
'           strSeikyuId     I       請求期間ID
'           strSeikyuFrom   I       請求書期間From(PH3)
'           strSeikyuTo     I       請求書期間To(PH3)
'           strHeiDanKbn    I       平残断面区分(PH3)
'           strMaeAtoPayKbn I       前払後払区分(PH3)
'           Sisan           O       検索結果の配列
'           lngSisanCnt     O       検索結果の行数
'
'戻り値　　：Boolean
'
'機能説明　：料率適用期間テーブルから請求対象合算口座番号で期間数分の一覧を取得する。
'           ※合算口座番号では、単一資産(資産分類："0"、資産コード："0000")のため期間のみ
'
'更新履歴　：2006/09/21 SRA Y.Azuma    新規作成
'更新履歴　：2007/03/29 SRA Y.Azuma    変更     (PH3)断面系口座情報取得
'
'*************************************************************************
Private Function func_GetTargetSisanInfoOya(ByVal strKohzaNo As String _
                                        , ByVal strSeikyuId As String _
                                        , ByVal strSeikyuFrom As String _
                                        , ByVal strSeikyuTo As String _
                                        , ByVal strHeiDanKbn As String _
                                        , ByVal strMaeAtoPayKbn As String _
                                        , ByRef Sisan() As Variant _
                                        , ByRef lngSisanCnt As Long) As Boolean
On Error GoTo ErrHandler

    Dim strSql      As String
    Dim vdata()     As Variant
    Dim lngCol      As Long
    Dim lngRow      As Long
    Dim lngRowCnt   As Long
    Dim lngColCnt   As Long
    
    func_GetTargetSisanInfoOya = False
'*******************************************************
'* 関数開始　                                        　*
'*******************************************************


    strSql = ""
    strSql = strSql & " SELECT  RTK.SHISAN_BUNRUI"              ' 0:資産分類
    strSql = strSql & "        ,RTK.SHISAN_CODE"                ' 1:資産コード
    strSql = strSql & "        ,RTK.RATE_TEKIYOH_KIKAN_FROM"    ' 2:料率適用期間From
    strSql = strSql & "        ,RTK.RATE_TEKIYOH_KIKAN_TO"      ' 3:料率適用期間To
    strSql = strSql & "        ,RTK.RATE_TEKIYOH_KIKAN_ID"      ' 4:料率適用期間ID
    strSql = strSql & "        ,RTK.KEISAN_HOHHOH"              ' 5:計算方法
    strSql = strSql & "        ,RTK.KISO_SUCHI_KEISAN_HOHHOH"   ' 6:基礎数値計算方法
    strSql = strSql & "        ,RTK.SEIKYU_KIKAN_ID"            ' 7:請求期間ID
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
    strSql = strSql & "        ,RTK.SEIKYUSHO_SHURUI "          ' 8:請求書種類
    strSql = strSql & "        ,RTK.RATE_CODE "                 ' 9:料率コード
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
    strSql = strSql & "    FROM KYK_RATE_TEKIYOH_KIKAN RTK"
    strSql = strSql & "   WHERE RTK.KOHZA_NO          =  '" & strKohzaNo & "'"
    strSql = strSql & "     AND RTK.SAKUJO_FLG        =  '0' "
    strSql = strSql & "     AND RTK.SEIKYU_KIKAN_ID   =  '" & strSeikyuId & "'"
    
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
    '顧問料請求管理の平残断面区分が「断面」かつ前払後払区分が「前払」の場合(断面A又は時価断面)
    If strHeiDanKbn = DANMEN And strMaeAtoPayKbn = MAE_BARAI Then
        strSql = strSql & " AND RTK.RATE_TEKIYOH_KIKAN_FROM = " & strSeikyuFrom
    Else
        strSql = strSql & " AND RTK.RATE_TEKIYOH_KIKAN_FROM <= " & strSeikyuTo
    End If
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
    
    strSql = strSql & " ORDER BY RTK.RATE_TEKIYOH_KIKAN_FROM"
    strSql = strSql & "         ,RTK.RATE_TEKIYOH_KIKAN_TO"
    strSql = strSql & "         ,RTK.SHISAN_BUNRUI "
    strSql = strSql & "         ,RTK.SHISAN_CODE "
    
    'データ取得
    Call gclsDB.DoExequteSql(gcSELECT, strSql, vdata, lngCol, lngRow)
    
    
    If lngRow = 0 Then
    'データなし
        Erase Sisan
        lngSisanCnt = 0
        func_GetTargetSisanInfoOya = True
        Exit Function
    Else
    'データあり
        ReDim Sisan(lngRow - 1, lngCol)
        lngSisanCnt = lngRow
        For lngRowCnt = 0 To lngRow - 1
            For lngColCnt = 0 To lngCol - 1
                Sisan(lngRowCnt, lngColCnt) = vdata(lngColCnt, lngRowCnt)
            Next lngColCnt
        Next lngRowCnt
    End If

    Erase vdata

    func_GetTargetSisanInfoOya = True
    Exit Function

ErrHandler:

    func_GetTargetSisanInfoOya = False
'Debug.Print strSql
'---- Error Log Start ----------------------------------------------------
    Dim lng As Long
    lng = Err.Number
    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "func_GetTargetSisanInfoOya", Err.Number, Err.Description)
    On Error GoTo 0
'    Err.Raise lng
'---- Error Log End   ----------------------------------------------------
    Erase vdata

End Function




'*************************************************************************
'関数名　　：
'
'引　　数　：
'           Sisan           I       検索結果の配列
'           strOutputDir    I       出力先フォルダ
'           strFileName     I       データファイル名(Pathなし)
'           strKohzaList()  I       処理対象口座配列配列
'           lngKKCnt        I       処理対象口座配列配列の添え字
'           typKohzaList()  I       合算口座構造体
'           lngKohzaCnt     I       合算口座構造体の添え字
'           typTorikomi     O       料率変更構造体
'           lngErrorCnt     O       エラー数
'
'戻り値　　：
'
'機能説明　：
'
'更新履歴　：2006/07/31 SRA Y.Azuma    新規作成
'更新履歴　：2006/10/20 SRA Y.Azuma    変更     合算で調整資産の算定作成しない(単No.222)
'更新履歴　：2006/10/25 SRA Y.Azuma    変更     案内の書類一覧固定変更(連No.225)
'更新履歴　：2006/11/17 SRA Y.Azuma    変更     (仕変)合算で調整資産の算定基礎出力
'更新履歴　：2007/01/30 SRA Y.Azuma    変更     (PH2)連No.24 成功報酬型でも上期は通常計算書
'更新履歴　：2007/02/14 SRA Y.Azuma    変更     (PH2)QANo.209 上期成功報酬対応
'更新履歴　：2007/02/23 SRA Y.Azuma    変更     (PH2)QANo.209 上期成功報酬条件変更
'更新履歴　：2007/03/29 SRA Y.Azuma    変更     (PH3)PH3請求書作成の対応
'更新履歴　：2007/04/20 SRA Y.Azuma    変更     (PH3)単体障害対応
'更新履歴　：2007/05/24 SRA Y.Azuma    変更     (PH3)連結　調整資産の時価平残時条件キャンセル'
'更新履歴　：2007/06/12 SRA Y.Azuma    変更     (PH3)連結　親算定基礎の明細未作成　障害53
'更新履歴　：2007/07/31 SRA Y.Azuma    変更     (PH3.5)PH3.5機能追加
'
'*************************************************************************
Private Function func_DataFileCustomize(ByRef Sisan() As Variant _
                                      , ByVal strOutputDir As String _
                                      , ByVal strFileName As String _
                                      , ByRef strKohzaList() As String _
                                      , ByVal lngKKCnt As Long _
                                      , ByRef typKohzaList() As typKohzaMain _
                                      , ByVal lngKohzaCnt As Long _
                                      , ByRef SisanOya() As Variant _
                                      , ByRef typTorikomi As TorikomiOutput _
                                      , ByRef lngErrorCnt As Long) As Boolean

On Error GoTo ErrHandler
    
    Const PROCEDURE_NAME = "func_DataFileCustomize"
   
    Dim lngSisan            As Long         'カウンタ(資産数)
    Dim lngOyaSisan         As Long         'カウンタ(親口座資産数)
    Dim lngCnt              As Long         'カウンタ
    Dim lngRateMdfSeq       As Long         '料率変更順No    (一般資産)
    Dim strRateTekiyoFrom   As String       '料率適用期間From(一般資産)
    Dim strRateTekiyoTo     As String       '料率適用期間To  (一般資産)
    Dim lngSisanCount       As Long         '料率期間あたりの資産カウント(一般資産)
    
    Dim lngChoseMdfSeq      As Long         '調整変更順No    (調整資産)
    Dim strChoseTekiyoFrom  As String       '調整適用期間From(調整資産)
    Dim strChoseTekiyoTo    As String       '調整適用期間To  (調整資産)
    Dim lngChoseSisanCount  As Long         '料率期間あたりの資産カウント(調整資産)
    
    Dim lngStartRow         As Long         '追加した行の始まり
    Dim lngEndRow           As Long         '追加した行の終わり
    
    Dim strSyorui()         As String       '書類名の一覧を格納
    Dim strSyoruiOut()      As String       '書類名の一覧を格納

    Dim lngSyorui           As Long
    Dim lngSanteiN6Cnt      As Long         '算定基礎のＮ６の資産数
    Dim lngSanteiN7Cnt      As Long         '算定基礎のＮ７の資産数
    Dim lngSanteiCnt        As Long         '算定基礎の資産数
    Dim lngT21Cnt           As Long         'T21資産の数
    Dim lngChousei          As Long
    Dim strMsgSyousai       As String       'エラー詳細用
    Dim strGassanKbn        As String       '合算区分(1:合算対象　0:合算対象ではない)
    Dim strSheetName        As String       'シート名　(行増幅時使用)
    Dim strOffSet           As String       'オフセット(行増幅時使用)
    Dim lngGassanKCnt       As Long         'カウンタ
    Dim blnJikosettei       As Boolean      '計算書・自己設定委託者報酬額の貼付フラグ
    Dim typChoseiNum()      As typChoseiSisanNum
    Dim strMae              As String
    Dim strAto              As String
    
    Dim strCell             As String
    Dim strChikanMae        As String
    Dim strChikanAto        As String
    Dim lngDelStart         As Long
    Dim lngDelEnd           As Long
    Dim lngStart            As Long
    
    Dim blnRet              As Boolean
    Dim strKikanNo          As String
            
    Dim Result              As TypSaitei
    Dim ResultKohza         As TypKohzaZokuse
    
    Dim dicT21SISAN         As Variant  '<------------ Modify azuma 2006/12/28
    Dim strBuff             As String   '<------------ Modify azuma 2006/12/28
    
    Dim lngN11Cnt           As Long     'N11資産数          '<----------- Modify azuma 2007/03/29 (PH3)
    Dim lngN12Cnt           As Long     'N12資産数          '<----------- Modify azuma 2007/07/31 (PH3.5)★★★☆

    
    
    func_DataFileCustomize = False
    
    lngRateMdfSeq = 0
    lngChoseMdfSeq = 0
    lngSisanCount = 0
    lngChoseSisanCount = 0
    lngT21Cnt = 0
    lngSyorui = 0
    lngChousei = 0
    lngOyaSisan = 0
    
    lngN11Cnt = 0       '<----------- Modify azuma 2007/03/29 (PH3)
    
    ReDim strDummy(0, 0)
    ReDim typChoseiNum(0)
    
    strRateTekiyoFrom = ""
    strRateTekiyoTo = ""
    strMsgSyousai = ""
    
    Set dicT21SISAN = CreateObject("Scripting.Dictionary")  '<------------ Modify azuma 2006/12/28
    dicT21SISAN.RemoveAll                                   '<------------ Modify azuma 2006/12/28
    
    blnJikosettei = False
    
'*******************************************************
'* 関数開始　                                        　*
'*******************************************************

    ThisWorkbook.Application.ScreenUpdating = False
    
    '合算区分の設定
    strGassanKbn = typKohzaList(lngKohzaCnt).GassanTaishohKbn



    'データシートカスタマイズ
        
    '0.共通の貼付       ※合算口座でも使用　　親口座で1回のみ貼付
    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    If lngKKCnt = 1 Then
        If strGassanKbn = KOHZA_GASSAN_ON Then
            strSheetName = DATASHEET_G_BASIC
        Else
            strSheetName = DATASHEET_BASIC
        End If
        strMsgSyousai = DATASHEET_BASIC
        Call sub_AddSheetItemRow(strFileName _
                               , strSheetName _
                               , lngKKCnt _
                               , "" _
                               , "" _
                               , "" _
                               , lngStartRow _
                               , lngEndRow)
'        lngEndRow = func_GetEndRow(strFileName, DATASHEET_DATA)
'        '*** ()で囲まれた文字列の置換
'        Call sub_ReplaceKeyItem(strFileName, strKohzaList(), lngKKCnt, 1, lngEndRow)
            
    End If
    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−


    '「書類送付のご案内・口座」の貼付
    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    '貼付前の最終行を取得
    lngStart = func_GetEndRow(strFileName, DATASHEET_DATA)
    
    Call sub_AddSheetItemRow(strFileName _
                           , DATASHEET_SOUFU_KOHZA _
                           , lngKKCnt _
                           , "" _
                           , "" _
                           , CStr(lngKKCnt - 1) _
                           , lngStartRow _
                           , lngEndRow)
    '*** ()で囲まれた文字列の置換
    Call sub_ReplaceKeyItem(strFileName, strKohzaList(), lngKKCnt, lngStart + 1, lngEndRow)

    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−

        
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
    '基礎数値計算方法が「9：引出(返戻)」の場合、指図書は必要なし
    
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------

'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
'断面Aの「指図書」作成可否の判定がこの場所で出来ない為移動
'''    '4.「指図書」の貼付     ※子口座分全て出力する。
'''    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'''    If strGassanKbn = KOHZA_GASSAN_ON Then
'''    '合算
'''        strSheetName = DATASHEET_G_SASIZU
'''        strOffSet = ""
'''        strMae = DATASHEET_INC_KOHZA & DATASHEET_INC_XX
'''        strAto = DATASHEET_INC_KOHZA & Format(lngKKCnt, "00")
'''    Else
'''    '親無し
'''        strSheetName = DATASHEET_SASIZU
'''        strOffSet = ""
'''        strMae = ""
'''        strAto = ""
'''    End If
'''    strMsgSyousai = strSheetName
'''    Call sub_AddSheetItemRow(strFileName _
'''                           , strSheetName _
'''                           , lngKKCnt _
'''                           , strMae _
'''                           , strAto _
'''                           , strOffSet _
'''                           , lngStartRow _
'''                           , lngEndRow)
'''    lngSisan = 0
'''    '「指図書」の条件への貼付け
'''    Call sub_SetJoukenData(strFileName, Sisan(), lngSisan, lngStartRow)
'''    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
                           
        
    '3-1.「請求書」の貼付
    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    If strGassanKbn = KOHZA_GASSAN_ON Then
    '「請求書」合算
    
                
        '「合算請求書・口座」の貼付
        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
        Call sub_AddSheetItemRow(strFileName _
                               , DATASHEET_G_SEIKYU_KHOZA _
                               , lngKKCnt _
                               , "" _
                               , "" _
                               , CStr(lngKKCnt - 1) _
                               , lngStartRow _
                               , lngEndRow)
'        lngSisan = 0
        '条件への貼付け
        Call sub_SetJoukenData(strFileName, Sisan(), 0, lngStartRow)
        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    
        '「合算請求書・その他」の貼付
        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
        '下期の場合のみ「上期課税前投資顧問料」、「差引き合計課税前投資顧問料」を表示する。
        If strKohzaList(lngKKCnt, KOHZALIST_HIZUKE_SHURUI) = HIZUKE_SHURUI_SIMO Then
            lngDelStart = 0
            lngDelEnd = 0
        Else
            lngDelStart = 2
            lngDelEnd = 3
        End If
        Call sub_AddSheetItemRow(strFileName _
                               , DATASHEET_G_SEIKYU_SONOTA _
                               , lngKKCnt _
                               , DATASHEET_INC_KOHZA & "01" _
                               , DATASHEET_INC_KOHZA & Format(lngKKCnt, "00") _
                               , (lngKKCnt) * GASSAN_OFFSET_BASE _
                               , lngStartRow _
                               , lngEndRow _
                               , DATASHEET_ITEMNAME_COL _
                               , lngDelStart _
                               , lngDelEnd)
'        lngSisan = 0
        '条件への貼付け
        Call sub_SetJoukenData(strFileName, Sisan(), 0, lngStartRow)
        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    
    
    
    Else
    '「請求書」親無し口座
        
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
'口座が断面系以外の場合、作成を行う
        If strKohzaList(lngKKCnt, KOHZALIST_HEIZAN_DANMEN_KBN) <> DANMEN Then
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
        
'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
            '【PH3.5】「ゼロ円請求書区分」がゼロ円請求の場合、ゼロ円請求書を作成
            If strKohzaList(lngKKCnt, KOHZALIST_ZEROEN_SEIKYU_KBN) = ZEROYEN_SEIKYU_YES Then
            
                'ゼロ円請求書を作成する。
                strMsgSyousai = DATASHEET_ZEROYEN_SEIKYU_SHO
                Call sub_AddSheetItemRow(strFileName _
                                       , DATASHEET_ZEROYEN_SEIKYU_SHO _
                                       , lngKKCnt _
                                       , "" _
                                       , "" _
                                       , "" _
                                       , lngStartRow _
                                       , lngEndRow)
            
            Else
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------

            'ゼロ円請求以外の場合
        
                '下期の場合のみ「上期課税前投資顧問料」、「差引き合計課税前投資顧問料」を表示する。
                If strKohzaList(lngKKCnt, KOHZALIST_HIZUKE_SHURUI) = HIZUKE_SHURUI_SIMO Then
                    lngDelStart = 0
                    lngDelEnd = 0
                Else
                    lngDelStart = 2
                    lngDelEnd = 3
                End If
                
                strMsgSyousai = DATASHEET_GOHKEI
                Call sub_AddSheetItemRow(strFileName _
                                       , DATASHEET_GOHKEI _
                                       , lngKKCnt _
                                       , "" _
                                       , "" _
                                       , "" _
                                       , lngStartRow _
                                       , lngEndRow _
                                       , "" _
                                       , lngDelStart _
                                       , lngDelEnd)
    
    
        '------------<Modify Start azuma 2006/12/20 (PH2)> -----------------------
                '***　最低保障　***
                '最低保障の額が0、NULL以外で日付種類が「下期」か「通期」の場合作成する。
                If strKohzaList(lngKKCnt, KOHZALIST_HIZUKE_SHURUI) = HIZUKE_SHURUI_SIMO Or _
                   strKohzaList(lngKKCnt, KOHZALIST_HIZUKE_SHURUI) = HIZUKE_SHURUI_TUKI Then
                
                    '最低補償額の取得
                    blnRet = func_SaiteHoshouFlg(strKohzaList() _
                                               , lngKKCnt _
                                               , Result)
                    If blnRet = False Then
                        With gusrErr
                            .ModuleId = MODULE_NAME         'モージュールID
                            .Procedure = PROCEDURE_NAME     'プロシージャID
                            .MsgCode = ERR_MSGCD_VB         'メッセージ区分
                            .ErrNum = Err.Number            'システムエラーコード
                            .ErrDescript = Err.Description  'システムエラー内容
                            .KohzaNo = strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
                            .MsgNaiyou = "顧問料最低保障フラグ取得失敗"        'メッセージ内容(ブックファイル名)
                            With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
                            gusrErr.MsgSyousai = "顧問料の計算が行われていない可能性があります。 " & vbCrLf _
                                            & "計算チェックをＯＮにして再計算をして下さい。" & vbCrLf _
                                            & "口座番号　　　：" & strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO) & vbCrLf _
                                            & "請求期間ID    ：" & strKohzaList(lngKKCnt, KOHZALIST_SEIKYU_KIKAN_ID) & vbCrLf _
                                            & "日付種類　    ：" & strKohzaList(lngKKCnt, KOHZALIST_HIZUKE_SHURUI)
                            End With
                            'エラーシート書き込み
                            Call fncWriteErrSheet(ERROR_SHEETNAME)
                            lngErrorCnt = lngErrorCnt + 1
                        End With
                    Else
                
                        '請求書・最低保障
                        
        '------------<Modify Start azuma 2007/01/26 > -----------------------
                        If Result.strSaiteYukouFlg = "1" Then
        '                If CDec(Result.valHoshohGaku) > 0 Then
        '------------<Modify End   azuma 2007/01/26 > -----------------------
                            strMsgSyousai = DATASHEET_GOHKEI4
                            Call sub_AddSheetItemRow(strFileName _
                                                   , DATASHEET_GOHKEI4 _
                                                   , lngKKCnt _
                                                   , "" _
                                                   , "" _
                                                   , "" _
                                                   , lngStartRow _
                                                   , lngEndRow)
                        
                        End If
                        
                        '請求書・最低保障文字
                        If Result.strSaiteYukouFlg = "1" Then
                            strMsgSyousai = DATASHEET_GOHKEI5
                            Call sub_AddSheetItemRow(strFileName _
                                                   , DATASHEET_GOHKEI5 _
                                                   , lngKKCnt _
                                                   , "" _
                                                   , "" _
                                                   , "" _
                                                   , lngStartRow _
                                                   , lngEndRow)
                        
                        End If
                    
                    End If
                End If
        '------------<Modify End   azuma 2006/12/20 (PH2)> -----------------------
    
        '        lngSisan = 0
                '「請求書」の条件への貼付け
                Call sub_SetJoukenData(strFileName, Sisan(), 0, lngStartRow, True)
        '        strSyorui(1, 1) = "1"   '書類作成フラグ設定
            
'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
            End If  'ゼロ円請求書作成条件の終わり
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------

'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
        End If  '「口座が断面系以外の場合、作成を行う」の終わり
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
    
    End If
    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−

'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
    '「書類送付のご案内」の貼付
    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    If lngKKCnt = 1 Then
                                      
        strMsgSyousai = DATASHEET_SOUFU
        Call sub_AddSheetItemRow(strFileName _
                               , DATASHEET_SOUFU _
                               , lngKKCnt _
                               , "" _
                               , "" _
                               , "" _
                               , lngStartRow _
                               , lngEndRow)
    End If
    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−

'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------



'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
    '【PH3.5】「ゼロ円請求書区分」がゼロ円請求の場合、処理を終了する。
    If strKohzaList(lngKKCnt, KOHZALIST_ZEROEN_SEIKYU_KBN) = ZEROYEN_SEIKYU_YES Then
        
        lngEndRow = func_GetEndRow(strFileName, DATASHEET_DATA)
        
        '*** ()で囲まれた文字列の置換
        Call sub_ReplaceKeyItem(strFileName, strKohzaList(), lngKKCnt, 1, lngEndRow)
        
        func_DataFileCustomize = True
        Exit Function
    End If
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------


    '＠資産数でループ
    For lngSisan = 0 To UBound(Sisan)

'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
        If lngSisan = 0 Then
            If (CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_DANMEN_A Or _
                CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_DANMEN) And _
               CStr(Sisan(lngSisan, SISANLIST_KISO_SUCHI_KEISAN_HOHHOH)) = KISO_SUCHI_HIKIDASHI Then
                '断面Aで基礎数値計算方法が「9：引出(返戻)」の場合、指図書は必要なし
                'よって作成処理なし
            Else
               
                '4.「指図書」の貼付     ※子口座分全て出力する。
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                If strGassanKbn = KOHZA_GASSAN_ON Then
                '合算
                    strSheetName = DATASHEET_G_SASIZU
                    strOffSet = ""
                    strMae = DATASHEET_INC_KOHZA & DATASHEET_INC_XX
                    strAto = DATASHEET_INC_KOHZA & Format(lngKKCnt, "00")
                Else
                '親無し
                    strSheetName = DATASHEET_SASIZU
                    strOffSet = ""
                    strMae = ""
                    strAto = ""
                End If
                strMsgSyousai = strSheetName
                Call sub_AddSheetItemRow(strFileName _
                                       , strSheetName _
                                       , lngKKCnt _
                                       , strMae _
                                       , strAto _
                                       , strOffSet _
                                       , lngStartRow _
                                       , lngEndRow)
                lngSisan = 0
                '「指図書」の条件への貼付け
                Call sub_SetJoukenData(strFileName, Sisan(), lngSisan, lngStartRow)
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
            End If
        End If
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------


        '料率変更の回数をカウント
        If CStr(Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI)) = "0" Then
        '資産分類＝０(一般資産)
        
'------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
            If strGassanKbn = KOHZA_GASSAN_ON Then
                strKikanNo = ""
                blnRet = False
                '合算の計算期間Noの設定
                blnRet = func_GKeisanKikan(CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)) _
                                         , CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_TO)) _
                                         , SisanOya() _
                                         , strKikanNo)
                If blnRet = False Then
                    Exit Function
                End If
            End If
'------------<Modify End   azuma 2006/11/01 連No.69> -----------------------

            lngSisanCount = lngSisanCount + 1
            If (CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)) <> strRateTekiyoFrom Or _
                CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_TO)) <> strRateTekiyoTo) Then
                
                '********************
                '**** 期中変更時 ****
                '********************
                
                lngSisanCount = 1
                lngN11Cnt = 0       '<----------- Modify azuma 2007/03/29 (PH3)
                lngN12Cnt = 0       '<----------- Modify azuma 2007/07/31 (PH3.5)★★★☆

                '料率変更順Noのインクリメント
                lngRateMdfSeq = lngRateMdfSeq + 1
                ReDim Preserve typTorikomi.RyouHen(lngRateMdfSeq)
                ReDim Preserve typTorikomi.RyouHen(lngRateMdfSeq).SisanCode(lngSisanCount)
                typTorikomi.RyouHen(lngRateMdfSeq).SisanCode(lngSisanCount).SisanCode = Sisan(lngSisan, SISANLIST_SHISAN_CODE)     '資産コード
                typTorikomi.RyouHen(lngRateMdfSeq).SisanCode(lngSisanCount).lngSisanCnt = lngSisan
                typTorikomi.RyouHen(lngRateMdfSeq).strKeisanHohhoh = Sisan(lngSisan, SISANLIST_KEISAN_HOHHOH)             '計算方法
                typTorikomi.RyouHen(lngRateMdfSeq).strKisoKeisanHohhoh = Sisan(lngSisan, SISANLIST_KISO_SUCHI_KEISAN_HOHHOH)         '基礎数値計算方法
                
                '「(合算)請求書・全体」の貼付
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                If strGassanKbn = KOHZA_GASSAN_ON Then
                '合算
                    '「合算請求書・全体」の貼付
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strSheetName = DATASHEET_G_SEIKYU_ZENTAI
                    strOffSet = CStr(lngRateMdfSeq - 1 + ((lngKKCnt) * GASSAN_OFFSET_BASE))
                    strCell = DATASHEET_ITEMNAME_COL
                    strChikanMae = DATASHEET_INC_KOHZA & "01"
                    strChikanAto = DATASHEET_INC_KOHZA & Format(lngKKCnt, "00")
                    
                    '＠資産分類＝０の全の資産で行貼付
                    strMsgSyousai = strSheetName
                    Call sub_AddSheetItemRow(strFileName _
                                           , strSheetName _
                                           , lngKKCnt _
                                           , strChikanMae _
                                           , strChikanAto _
                                           , strOffSet _
                                           , lngStartRow _
                                           , lngEndRow, strCell)
                
                    'MULTI項目へ期間の貼付
                    Call sub_FillinMultItem(strFileName _
                                           , DATASHEET_DATA _
                                           , lngStartRow + 2 _
                                           , lngStartRow + 2 _
                                           , DATASHEET_RESULT_COL _
                                           , strKikanNo)
                                       
                    '条件への貼付け
                    Call sub_SetJoukenData(strFileName _
                                         , Sisan() _
                                         , lngSisan _
                                         , lngStartRow _
                                         , True)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                Else
                '親無し
                
'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                    If CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_HEIZAN Or _
                       CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_HEIZAN Or _
                       CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_N11 Or _
                       CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_SHINTAKU_JIKA Or _
                       CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_SANJUTSU_HEIKN Or _
                       CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_KOKYAKU_A Or _
                       CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_KOKYAKU_B Then
                    '請求書種類＝時価平残、元本平残、N11、日次、時価算術平均の場合
                    
'    '------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
'                        If CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_HEIZAN Or _
'                           CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_HEIZAN Or _
'                           CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_N11 Then
'                        '請求書種類＝時価平残、元本平残、N11の場合
'    '------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                    
                
                        '「請求書・全体」の貼付
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        strSheetName = DATASHEET_GOHKEI1
                        strOffSet = CStr(lngRateMdfSeq - 1)
                        strCell = DATASHEET_SHEETHEAD_COL
                        strChikanMae = ""
                        strChikanAto = ""
                        '＠資産分類＝０の全の資産で行貼付
                        strMsgSyousai = strSheetName
                        Call sub_AddSheetItemRow(strFileName _
                                               , strSheetName _
                                               , lngKKCnt _
                                               , strChikanMae _
                                               , strChikanAto _
                                               , strOffSet _
                                               , lngStartRow _
                                               , lngEndRow, strCell)
                                               
        '------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
        '                If strGassanKbn = KOHZA_GASSAN_ON Then
        '                    strKikanNo = ""
        '                    blnRet = False
        '                    '合算の計算期間Noの設定
        '                    blnRet = func_GKeisanKikan(CStr(Sisan(lngSisan, 2)) _
        '                                             , CStr(Sisan(lngSisan, 3)) _
        '                                             , SisanOya() _
        '                                             , strKikanNo)
        '                    If blnRet = False Then
        '                        Exit Function
        '                    End If
                        'MULTI項目へ期間の貼付
                        Call sub_FillinMultItem(strFileName _
                                               , DATASHEET_DATA _
                                               , lngStartRow + 2 _
                                               , lngStartRow + 2 _
                                               , DATASHEET_RESULT_COL _
                                               , strKikanNo)
        '                End If
        '------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
                                               
                        '条件への貼付け
                        Call sub_SetJoukenData(strFileName _
                                             , Sisan() _
                                             , lngSisan _
                                             , lngStartRow _
                                             , True)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                    ElseIf (CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_DANMEN And CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)) = strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM) And _
                            CStr(Sisan(lngSisan, SISANLIST_KISO_SUCHI_KEISAN_HOHHOH)) <> KISO_SUCHI_HIKIDASHI) _
                        Or (CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_DANMEN_B And CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)) <= strKohzaList(lngKKCnt, KOHZALIST_SEIKYU_YMD)) _
                        Or (CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_DANMEN_A And CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)) = strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM) And _
                            CStr(Sisan(lngSisan, SISANLIST_KISO_SUCHI_KEISAN_HOHHOH)) <> KISO_SUCHI_HIKIDASHI) Then
                        '※但し、断面Aで引出(返戻)の場合は作成しない
                        
                        If lngRateMdfSeq = 1 Then
                            '「断面用請求書」の貼付
                            '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                            strSheetName = DATASHEET_DANMEN_SEIKYU_SHO  '前受請求書
                            strOffSet = ""
                            strCell = DATASHEET_SHEETHEAD_COL
                            strChikanMae = DATASHEET_INC_SHORUI & DATASHEET_INC_HIKAE
                            strChikanAto = DATASHEET_INC_SHORUI
                            Call sub_AddSheetItemRow(strFileName _
                                                   , strSheetName _
                                                   , lngKKCnt _
                                                   , strChikanMae _
                                                   , strChikanAto _
                                                   , strOffSet _
                                                   , lngStartRow _
                                                   , lngEndRow, strCell, 2, 2)
                            '条件への貼付け
                            Call sub_SetJoukenData(strFileName _
                                                 , Sisan() _
                                                 , lngSisan _
                                                 , lngStartRow _
                                                 , True)
                            
                            '「後払」の場合、請求書の控を作成しない
                            If strKohzaList(lngKKCnt, KOHZALIST_MAE_ATO_BARAI_KBN) <> ATO_BARAI Then
                                '------(控)分の作成------
                                strChikanMae = DATASHEET_INC_SHORUI & DATASHEET_INC_HIKAE
                                strChikanAto = DATASHEET_INC_SHORUI & DATASHEET_INC_HIKAE
                                Call sub_AddSheetItemRow(strFileName _
                                                       , strSheetName _
                                                       , lngKKCnt _
                                                       , strChikanMae _
                                                       , strChikanAto _
                                                       , strOffSet _
                                                       , lngStartRow _
                                                       , lngEndRow, strCell, 1, 1)
                                '条件への貼付け
                                Call sub_SetJoukenData(strFileName _
                                                     , Sisan() _
                                                     , lngSisan _
                                                     , lngStartRow _
                                                     , True)
                                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                            End If
                        End If
                        
                    End If
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
                    
                End If  '合算のEND
            
                
                '合算口座で1口座分
                If strGassanKbn = KOHZA_GASSAN_ON Then
                '合算
                    
                    
                            
                    '「親口座計算書・口座」の貼付
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
'------------<Modify Start azuma 2006/11/08 連No.91> -----------------------
'                    Call sub_AddSheetItemRow(strFileName _
'                                           , DATASHEET_G_OYA_KEISAN_KOHZA _
'                                           , lngKKCnt _
'                                           , DATASHEET_INC_KIKAN & DATASHEET_INC_XXX _
'                                           , DATASHEET_INC_KIKAN & Format(strKikanNo, "000") _
'                                           , CStr(lngKKCnt - 1) _
'                                           , lngStartRow _
'                                           , lngEndRow)
'------------<Modify End   azuma 2006/11/08 連No.91> -----------------------
'                    Call sub_AddSheetItemRow(strFileName _
'                                           , DATASHEET_G_OYA_KEISAN_KOHZA _
'                                           , lngKKCnt _
'                                           , DATASHEET_INC_KIKAN & DATASHEET_INC_XXX _
'                                           , DATASHEET_INC_KIKAN & Format(lngRateMdfSeq, "000") _
'                                           , CStr(lngKKCnt - 1) _
'                                           , lngStartRow _
'                                           , lngEndRow)
'                    lngSisan = 0
'                    '条件への貼付け
'                    Call sub_SetJoukenData(strFileName, Sisan(), 0, lngStartRow)
'------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                    '親口座計算書・期間顧問料
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strMsgSyousai = DATASHEET_G_OYA_KEISAN_KIKAN
'------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
                    Call sub_GKeisanOya_Kikan(strFileName _
                                      , CLng(strKikanNo) _
                                      , Sisan() _
                                      , lngSisan _
                                      , strKohzaList() _
                                      , lngKKCnt)
'                    Call sub_GKeisanOya_Kikan(strFileName _
'                                      , lngRateMdfSeq _
'                                      , Sisan() _
'                                      , lngSisan _
'                                      , strKohzaList() _
'                                      , lngKKCnt)
'------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                                        
                    '「親算定基礎・口座」の貼付
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−

'------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
'------------<Modify Start azuma 2006/11/08 連No.91> -----------------------
'                    Call sub_AddSheetItemRow(strFileName _
'                                           , DATASHEET_G_OYA_SANTEI_KOHZA _
'                                           , lngKKCnt _
'                                           , DATASHEET_INC_KIKAN & DATASHEET_INC_XXX _
'                                           , DATASHEET_INC_KIKAN & Format(strKikanNo, "000") _
'                                           , CStr(lngKKCnt - 1) _
'                                           , lngStartRow _
'                                           , lngEndRow)
'------------<Modify End   azuma 2006/11/08 連No.91> -----------------------
'                    Call sub_AddSheetItemRow(strFileName _
'                                           , DATASHEET_G_OYA_SANTEI_KOHZA _
'                                           , lngKKCnt _
'                                           , DATASHEET_INC_KIKAN & DATASHEET_INC_XXX _
'                                           , DATASHEET_INC_KIKAN & Format(lngRateMdfSeq, "000") _
'                                           , CStr(lngKKCnt - 1) _
'                                           , lngStartRow _
'                                           , lngEndRow)
'------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
'                    lngSisan = 0
                    '条件への貼付け
                    Call sub_SetJoukenData(strFileName, Sisan(), 0, lngStartRow)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
'------------<Modify Start azuma 2007/06/12 (PH3)> -----------------------
'''                    '１口座分だけ処理すればよいデータ
''''------------<Modify Start azuma 2007/01/25 > -----------------------
'''                    If lngKKCnt = 1 Then
''''                    If lngKKCnt = 1 Then
''''------------<Modify End   azuma 2007/01/25 > -----------------------
'''
''''                        lngSisan = 0
'''                        '親算定基礎
'''                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'''                        strMsgSyousai = DATASHEET_G_OYA_SANTEI
''''------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
'''                        If lngOyaSisan <= UBound(SisanOya) Then
'''                            Call sub_GOyaSantei(strFileName _
'''                                              , lngRateMdfSeq _
'''                                              , SisanOya() _
'''                                              , lngOyaSisan _
'''                                              , strKohzaList() _
'''                                              , lngKKCnt _
'''                                              , lngErrorCnt _
'''                                              , strKikanNo)
'''                            lngOyaSisan = lngOyaSisan + 1
'''
'''                        End If
''''                        Call sub_GOyaSantei(strFileName _
''''                                          , lngRateMdfSeq _
''''                                          , SisanOya() _
''''                                          , 0 _
''''                                          , strKohzaList() _
''''                                          , lngKKCnt _
''''                                          , lngErrorCnt)
''''------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
'''                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'''                    End If
'------------<Modify End   azuma 2007/06/12 (PH3)> -----------------------
                    
                    
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
''                End If
''
''                If strGassanKbn = KOHZA_GASSAN_ON Then
''                '合算の場合
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------


                    '5,6.算定基礎(月末・月中) ※
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strMsgSyousai = DATASHEET_G_KISO_SUCHI1 & " " & DATASHEET_G_KISO_SUCHI2
'------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
                    Call sub_GKeisanKiso(strFileName _
                                      , lngRateMdfSeq _
                                      , lngSanteiCnt _
                                      , Sisan() _
                                      , lngSisan _
                                      , strKohzaList() _
                                      , lngKKCnt _
                                      , lngErrorCnt _
                                      , strKikanNo)
'                    Call sub_GKeisanKiso(strFileName _
'                                      , lngRateMdfSeq _
'                                      , lngSanteiCnt _
'                                      , Sisan() _
'                                      , lngSisan _
'                                      , strKohzaList() _
'                                      , lngKKCnt _
'                                      , lngErrorCnt)
'------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                Else
                '合算以外

'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                    '請求書種類ごとの総計算書振り分け
                    If CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_HEIZAN Or _
                       CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_HEIZAN Or _
                       CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_SANJUTSU_HEIKN Then
                        '請求書種類＝時価平残、元本平残、時価算術平均の場合
                        
'    '------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
'                        '請求書種類ごとの総計算書振り分け
'                        If CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_HEIZAN Or _
'                           CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_HEIZAN Then
'                            '請求書種類＝時価平残、元本平残の場合
'    '------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                
                    
                        '5,6.算定基礎(月末・月中) ※親なしのみ
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        lngSanteiN6Cnt = 1
                        lngSanteiN7Cnt = 1
                        lngSanteiCnt = 1
                        '＠資産分類＝０の全ての資産で行貼付
                        strMsgSyousai = DATASHEET_KISO_SUCHI1 & " " & DATASHEET_KISO_SUCHI2
                            Call sub_KeisanKiso(strFileName _
                                          , lngRateMdfSeq _
                                          , lngSanteiCnt _
                                          , Sisan() _
                                          , lngSisan _
                                          , strKohzaList() _
                                          , lngKKCnt _
                                          , lngErrorCnt)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                    '7.総計算書　※親なしのみ
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
'------------<Modify Start azuma 2006/12/20 (PH2)> -----------------------
            '総計算書・掛け目B
            '※口座属性の成功報酬対象区分="1"かつ成功報酬タイプ="2"の場合
            
                        '口座属性の取得
                        blnRet = func_KohzaZokusei(strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO) _
                                                   , ResultKohza)
                        If blnRet = False Then
                            With gusrErr
                                .ModuleId = MODULE_NAME         'モージュールID
                                .Procedure = PROCEDURE_NAME     'プロシージャID
                                .MsgCode = ERR_MSGCD_VB         'メッセージ区分
                                .ErrNum = Err.Number            'システムエラーコード
                                .ErrDescript = Err.Description  'システムエラー内容
                                .KohzaNo = strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
                                .MsgNaiyou = "口座属性取得失敗" 'メッセージ内容
                                With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
                                gusrErr.MsgSyousai = "口座属性の登録が必要です。 " & vbCrLf _
                                                & "口座属性登録画面で口座情報を登録して下さい。" & vbCrLf _
                                                & "口座番号       :" & strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO) & vbCrLf _
                                                & "請求期間ID     :" & strKohzaList(lngKKCnt, KOHZALIST_SEIKYU_KIKAN_ID) & vbCrLf _
                                                & "日付種類　     :" & strKohzaList(lngKKCnt, KOHZALIST_HIZUKE_SHURUI)
                                End With
                                'エラーシート書き込み
                                Call fncWriteErrSheet(ERROR_SHEETNAME)
                                lngErrorCnt = lngErrorCnt + 1
                            End With
                        End If
        
            
'------------<Modify Start azuma 2007/02/23 > -----------------------
                        If ResultKohza.seikoh_hohshu_kbn = "0" Then
''------------<Modify Start azuma 2007/02/14 > -----------------------
'                        If ResultKohza.seikoh_hohshu_kbn = "0" _
'                        Or (ResultKohza.seikoh_hohshu_kbn = "1" And strKohzaList(lngKKCnt, KOHZALIST_HIZUKE_SHURUI) = HIZUKE_SHURUI_KAMI _
'                            And Trim(ResultKohza.kami_mishu_kakeme_rate) = "") Then
'''------------<Modify Start azuma 2007/01/30 > -----------------------
''                        If ResultKohza.seikoh_hohshu_kbn = "0" _
''                        Or strKohzaList(lngKKCnt, KOHZALIST_HIZUKE_SHURUI) = HIZUKE_SHURUI_KAMI Then
'''                        If ResultKohza.seikoh_hohshu_kbn = "0" Then
'''------------<Modify End   azuma 2007/01/30 > -----------------------
''------------<Modify End   azuma 2007/02/14 > -----------------------
'------------<Modify End   azuma 2007/02/23 > -----------------------
                        '成功報酬対象外
                            strMsgSyousai = DATASHEET_ZENTAI
                            Call sub_SouKeisan(strFileName _
                                              , DATASHEET_ZENTAI _
                                              , lngRateMdfSeq _
                                              , lngSanteiCnt _
                                              , Sisan() _
                                              , lngSisan _
                                              , strKohzaList() _
                                              , lngKKCnt _
                                              , lngErrorCnt)
                                              
                        ElseIf ResultKohza.seikoh_hohshu_kbn = "1" Then
                        '成功報酬対象
                        
                            Select Case ResultKohza.seikoh_hohshu_type
                                Case "1"
                                '1:掛け目型A(料率段階で掛ける)
                                    strMsgSyousai = DATASHEET_KAKEME_TYPE1
                                    Call sub_SouKeisan(strFileName _
                                                      , DATASHEET_KAKEME_TYPE1 _
                                                      , lngRateMdfSeq _
                                                      , lngSanteiCnt _
                                                      , Sisan() _
                                                      , lngSisan _
                                                      , strKohzaList() _
                                                      , lngKKCnt _
                                                      , lngErrorCnt)
                                                      
    
                                Case "2"
                                '2: 掛け目型B (年間顧問料で掛ける)
                                    strMsgSyousai = DATASHEET_ZENTAI
                                    Call sub_SouKeisan(strFileName _
                                                      , DATASHEET_ZENTAI _
                                                      , lngRateMdfSeq _
                                                      , lngSanteiCnt _
                                                      , Sisan() _
                                                      , lngSisan _
                                                      , strKohzaList() _
                                                      , lngKKCnt _
                                                      , lngErrorCnt)
    
                                    '総計算書・掛け目B
                                    strMsgSyousai = DATASHEET_KAKEME_TYPE2
                                    Call sub_SouKeisan_KakemeB(strFileName _
                                                      , lngRateMdfSeq _
                                                      , lngSanteiCnt _
                                                      , Sisan() _
                                                      , lngSisan _
                                                      , strKohzaList() _
                                                      , lngKKCnt _
                                                      , ResultKohza.anbun_hohhoh _
                                                      , lngErrorCnt)
                                                      
                                
                                Case "3"
                                '3: 残高型
                                    strMsgSyousai = DATASHEET_KAKEME_TYPE3
                                    Call sub_SouKeisan(strFileName _
                                                      , DATASHEET_KAKEME_TYPE3 _
                                                      , lngRateMdfSeq _
                                                      , lngSanteiCnt _
                                                      , Sisan() _
                                                      , lngSisan _
                                                      , strKohzaList() _
                                                      , lngKKCnt _
                                                      , lngErrorCnt)
                                                      
                            End Select
                            
                        
                        End If
                                          
'------------<Modify End   azuma 2006/12/20 (PH2)> -----------------------
                                          
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                    ElseIf CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_N11 Then
                    '請求書種類＝N11の場合
                        lngN11Cnt = lngN11Cnt + 1
                        
                        
                        
'------------<Modify Start azuma 2007/04/20 (PH3)> -----------------------
                        If lngN11Cnt = 1 And lngRateMdfSeq = 1 Then
'                        If lngN11Cnt = 1 Then
'------------<Modify End   azuma 2007/04/20 (PH3)> -----------------------
                    
                            '「N11計算表」の作成
                            '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                            strSheetName = DATASHEET_N11_KSAN_HYOU  'N11計算表
                            strOffSet = ""
                            strCell = DATASHEET_SHEETHEAD_COL
                            strChikanMae = ""
                            strChikanAto = ""
                            Call sub_AddSheetItemRow(strFileName _
                                                   , strSheetName _
                                                   , lngKKCnt _
                                                   , strChikanMae _
                                                   , strChikanAto _
                                                   , strOffSet _
                                                   , lngStartRow _
                                                   , lngEndRow, strCell)
                            '条件への貼付け
                            Call sub_SetJoukenData(strFileName _
                                                 , Sisan() _
                                                 , lngSisan _
                                                 , lngStartRow _
                                                 , True)
                            '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        
                            '「N11計算表・月末時価」の作成
                            '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                            Call sub_N11KsanHyouGetsuJika(strFileName _
                                                     , DATASHEET_N11_KSAN_HYOU_GETSU_JIKA _
                                                     , Sisan() _
                                                     , lngSanteiCnt _
                                                     , strKohzaList() _
                                                     , lngKKCnt _
                                                     , lngErrorCnt)
                            '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        End If
                        
                        
                        '「N11計算表・全体」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanHyouZentai(strFileName _
                                                , lngRateMdfSeq _
                                                , Sisan() _
                                                , lngSisan _
                                                , strKohzaList() _
                                                , lngKKCnt)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        
                        '「N11計算表・期中平均」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanHyouHeikinGaku(strFileName _
                                                , lngRateMdfSeq _
                                                , Sisan() _
                                                , lngSisan _
                                                , strKohzaList() _
                                                , lngKKCnt)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                    
                        
                        '「N11計算書」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        strSheetName = DATASHEET_N11_KSAN_SHO  'N11計算書
                        strOffSet = ""
                        strCell = DATASHEET_SHEETHEAD_COL
                        strChikanMae = DATASHEET_INC_KIKAN & DATASHEET_INC_XXX
                        strChikanAto = DATASHEET_INC_KIKAN & Format(lngRateMdfSeq, "000")
                        Call sub_AddSheetItemRow(strFileName _
                                               , strSheetName _
                                               , lngKKCnt _
                                               , strChikanMae _
                                               , strChikanAto _
                                               , strOffSet _
                                               , lngStartRow _
                                               , lngEndRow, strCell)
                        '条件への貼付け
                        Call sub_SetJoukenData(strFileName _
                                             , Sisan() _
                                             , lngSisan _
                                             , lngStartRow _
                                             , True)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                        '「N11計算書・月末日」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanShoGetsuJika(strFileName _
                                                 , DATASHEET_N11_KSAN_SHO_GETSU_BI _
                                                 , lngRateMdfSeq _
                                                 , Sisan() _
                                                 , lngSisan _
                                                 , strKohzaList() _
                                                 , lngKKCnt _
                                                 , lngErrorCnt)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        
                        '「N11計算書・月末時価」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanShoGetsuJika(strFileName _
                                                 , DATASHEET_N11_KSAN_SHO_GETSU_JIKA _
                                                 , lngRateMdfSeq _
                                                 , Sisan() _
                                                 , lngSisan _
                                                 , strKohzaList() _
                                                 , lngKKCnt _
                                                 , lngErrorCnt)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        
                        
                        '「N11計算書・資産1〜4」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanShoSisan(strFileName _
                                                , lngRateMdfSeq _
                                                , lngN11Cnt _
                                                , Sisan() _
                                                , lngSisan _
                                                , strKohzaList() _
                                                , lngKKCnt _
                                                , DATASHEET_N11_KSAN_SHO)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                        '「N11計算書・資産1〜4段階」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanShoSisanDankai(strFileName _
                                                    , lngRateMdfSeq _
                                                    , lngN11Cnt _
                                                    , Sisan() _
                                                    , lngSisan _
                                                    , strKohzaList() _
                                                    , lngKKCnt _
                                                    , lngErrorCnt _
                                                    , DATASHEET_N11_KSAN_SHO)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                    ElseIf CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_SHINTAKU_JIKA Then
                    '請求書種類が日次信託時価の場合
                    
                        '日次計算書の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_Shintakujika_KeisanSho(strFileName _
                                          , lngRateMdfSeq _
                                          , lngSanteiCnt _
                                          , Sisan() _
                                          , lngSisan _
                                          , strKohzaList() _
                                          , lngKKCnt _
                                          , lngErrorCnt)
                                          
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        
                        '日次料率一覧の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_NichijiRate(strFileName _
                                           , lngRateMdfSeq _
                                           , Sisan() _
                                           , lngSisan _
                                           , strKohzaList() _
                                           , lngKKCnt _
                                           , lngErrorCnt)
                        
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        
                    ElseIf CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_KOKYAKU_A Then
                    '請求書種類が顧客指定Ａの場合
                    
                        lngN12Cnt = lngN12Cnt + 1
                        
                        '「顧客指定Ａ計算書」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        strSheetName = DATASHEET_A_KSAN_SHO  '顧客指定Ａ計算書
                        strOffSet = ""
                        strCell = DATASHEET_SHEETHEAD_COL
                        strChikanMae = DATASHEET_INC_KIKAN & DATASHEET_INC_XXX
                        strChikanAto = DATASHEET_INC_KIKAN & Format(lngRateMdfSeq, "000")
                        Call sub_AddSheetItemRow(strFileName _
                                               , strSheetName _
                                               , lngKKCnt _
                                               , strChikanMae _
                                               , strChikanAto _
                                               , strOffSet _
                                               , lngStartRow _
                                               , lngEndRow, strCell)
                        '条件への貼付け
                        Call sub_SetJoukenData(strFileName _
                                             , Sisan() _
                                             , lngSisan _
                                             , lngStartRow _
                                             , True)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                        '「顧客指定Ａ計算書・月末日」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanShoGetsuJika(strFileName _
                                                 , DATASHEET_A_KSAN_SHO_GETSU_BI _
                                                 , lngRateMdfSeq _
                                                 , Sisan() _
                                                 , lngSisan _
                                                 , strKohzaList() _
                                                 , lngKKCnt _
                                                 , lngErrorCnt)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        
                        '「顧客指定Ａ計算書・月末時価」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanShoGetsuJika(strFileName _
                                                 , DATASHEET_A_KSAN_SHO_GETSU_JIKA _
                                                 , lngRateMdfSeq _
                                                 , Sisan() _
                                                 , lngSisan _
                                                 , strKohzaList() _
                                                 , lngKKCnt _
                                                 , lngErrorCnt)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        
                        
                        '「顧客指定Ａ計算書・資産1〜4」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanShoSisan(strFileName _
                                                , lngRateMdfSeq _
                                                , lngN12Cnt _
                                                , Sisan() _
                                                , lngSisan _
                                                , strKohzaList() _
                                                , lngKKCnt _
                                                , DATASHEET_A_KSAN_SHO)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                        '「顧客指定Ａ計算書・資産1〜4段階」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanShoSisanDankai(strFileName _
                                                    , lngRateMdfSeq _
                                                    , lngN12Cnt _
                                                    , Sisan() _
                                                    , lngSisan _
                                                    , strKohzaList() _
                                                    , lngKKCnt _
                                                    , lngErrorCnt _
                                                    , DATASHEET_A_KSAN_SHO)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                    ElseIf CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_KOKYAKU_B Then
                    '請求書種類が顧客指定Ｂの場合
                    
                        
                        '「顧客指定Ｂ計算書」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        strSheetName = DATASHEET_B_KSAN_SHO  '顧客指定Ｂ計算書
                        strOffSet = ""
                        strCell = DATASHEET_SHEETHEAD_COL
                        strChikanMae = DATASHEET_INC_KIKAN & DATASHEET_INC_XXX
                        strChikanAto = DATASHEET_INC_KIKAN & Format(lngRateMdfSeq, "000")
                        Call sub_AddSheetItemRow(strFileName _
                                               , strSheetName _
                                               , lngKKCnt _
                                               , strChikanMae _
                                               , strChikanAto _
                                               , strOffSet _
                                               , lngStartRow _
                                               , lngEndRow, strCell)
                        '条件への貼付け
                        Call sub_SetJoukenData(strFileName _
                                             , Sisan() _
                                             , lngSisan _
                                             , lngStartRow _
                                             , True)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                        '「顧客指定Ｂ計算書・基礎数値」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_N11KsanShoGetsuJika(strFileName _
                                                 , DATASHEET_B_KSAN_SHO_KISO_SUCHI _
                                                 , lngRateMdfSeq _
                                                 , Sisan() _
                                                 , lngSisan _
                                                 , strKohzaList() _
                                                 , lngKKCnt _
                                                 , lngErrorCnt)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−

                        '「顧客指定Ｂ計算書・料率段階」の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Call sub_B_KsanShoRateDankai(strFileName _
                                                 , lngRateMdfSeq _
                                                 , Sisan() _
                                                 , lngSisan _
                                                 , strKohzaList() _
                                                 , lngKKCnt _
                                                 , lngErrorCnt _
                                                 , DATASHEET_B_KSAN_SHO_RATE_DAN)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        
                    
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                    
                    ElseIf ((CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_DANMEN Or _
                         CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_DANMEN_A) And _
                         CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)) = strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM)) Or _
                       ((CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_DANMEN_B) And _
                         CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)) <= strKohzaList(lngKKCnt, KOHZALIST_SEIKYU_YMD)) Then
                    
                        '断面用計算明細書の作成
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        strMsgSyousai = DATASHEET_DANMEN_KEISAN_SHO
                        Call sub_DanmenKeisan(strFileName _
                                          , DATASHEET_DANMEN_KEISAN_SHO _
                                          , lngRateMdfSeq _
                                          , lngSanteiCnt _
                                          , Sisan() _
                                          , lngSisan _
                                          , strKohzaList() _
                                          , lngKKCnt _
                                          , "0" _
                                          , lngErrorCnt)
                        
                        '------(控)分の作成------
                        If CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) <> SHURUI_GANP_DANMEN_B Then
                            Call sub_DanmenKeisan(strFileName _
                                              , DATASHEET_DANMEN_KEISAN_SHO _
                                              , lngRateMdfSeq _
                                              , lngSanteiCnt _
                                              , Sisan() _
                                              , lngSisan _
                                              , strKohzaList() _
                                              , lngKKCnt _
                                              , "1" _
                                              , lngErrorCnt)
                        End If
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−

                    End If  '「請求書種類ごとの総計算書振り分け」の終わり
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
                                          
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                End If  '「合算の場合」の終わり
                
                If CStr(Sisan(lngSisan, SISANLIST_KEISAN_HOHHOH)) = KEISAN_HO_N07 And strGassanKbn = KOHZA_GASSAN_OFF Then
                '顧問料計算方法＝Ｎ７の場合
                
                    '10-1.合成料率          ※親無しのみ
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strMsgSyousai = DATASHEET_GOHSEI
                    Call sub_GouseiRate(strFileName _
                                      , lngRateMdfSeq _
                                      , lngSanteiCnt _
                                      , Sisan() _
                                      , lngSisan _
                                      , strKohzaList() _
                                      , lngKKCnt _
                                      , lngErrorCnt)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                    '10-2.合成料率・資産割合    ※親無しのみ
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strMsgSyousai = DATASHEET_GOHSEI_WARIAI
                    Call sub_GouseiWariai(strFileName _
                                        , lngRateMdfSeq _
                                        , Sisan() _
                                        , lngSisan _
                                        , lngSanteiN7Cnt _
                                        , lngKKCnt)
                           
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                    
                    '11.料率(資産別特化型料率)  ※親無しのみ
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strMsgSyousai = DATASHEET_TOKUKA_GATA
                    Call sub_TokukagataRate(strFileName _
                                        , lngRateMdfSeq _
                                        , Sisan() _
                                        , lngSisan _
                                        , strKohzaList() _
                                        , lngKKCnt _
                                        , lngSanteiN7Cnt _
                                        , lngErrorCnt)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                
                
                End If
            
            
            
            Else
            
                '**********************
                '**** 期中変更以外 ****
                '**********************
            
                ReDim Preserve typTorikomi.RyouHen(lngRateMdfSeq).SisanCode(lngSisanCount)
                typTorikomi.RyouHen(lngRateMdfSeq).SisanCode(lngSisanCount).SisanCode = Sisan(lngSisan, SISANLIST_SHISAN_CODE)
                typTorikomi.RyouHen(lngRateMdfSeq).SisanCode(lngSisanCount).lngSisanCnt = lngSisan
                
                If strGassanKbn = KOHZA_GASSAN_ON Then
                    '5,6.算定基礎(月末・月中)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strMsgSyousai = DATASHEET_G_KISO_SUCHI1 & " " & DATASHEET_G_KISO_SUCHI2
                    Call sub_GKeisanKiso(strFileName _
                                      , lngRateMdfSeq _
                                      , lngSanteiCnt _
                                      , Sisan() _
                                      , lngSisan _
                                      , strKohzaList() _
                                      , lngKKCnt _
                                      , lngErrorCnt _
                                      , strKikanNo)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                Else
                    
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                    If CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_HEIZAN Or _
                       CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_HEIZAN Then
                    '請求書種類＝時価平残の場合のみ作成
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------

                        '5,6.算定基礎(月末・月中)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        If CStr(Sisan(lngSisan, SISANLIST_KEISAN_HOHHOH)) = KEISAN_HO_N06 Then
                            lngSanteiN6Cnt = lngSanteiN6Cnt + 1
                            lngSanteiCnt = lngSanteiN6Cnt
                        ElseIf CStr(Sisan(lngSisan, SISANLIST_KEISAN_HOHHOH)) = KEISAN_HO_N07 Then
                            lngSanteiN7Cnt = lngSanteiN7Cnt + 1
                            lngSanteiCnt = lngSanteiN7Cnt
                        End If
                        
                        If CStr(Sisan(lngSisan, SISANLIST_KEISAN_HOHHOH)) = KEISAN_HO_N07 Then
                        
                            '＠資産分類＝０の全ての資産で行貼付
                            strMsgSyousai = DATASHEET_KISO_SUCHI1 & " " & DATASHEET_KISO_SUCHI2
                            Call sub_KeisanKiso(strFileName _
                                              , lngRateMdfSeq _
                                              , lngSanteiCnt _
                                              , Sisan() _
                                              , lngSisan _
                                              , strKohzaList() _
                                              , lngKKCnt _
                                              , lngErrorCnt)
                        End If
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                    End If  '「請求書種類＝時価平残,時価平残の場合のみ作成」の終わり
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
                End If
                                
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                If CStr(Sisan(lngSisan, SISANLIST_KEISAN_HOHHOH)) = KEISAN_HO_N07 And strGassanKbn = KOHZA_GASSAN_OFF Then
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
                '顧問料計算方法≠Ｎ６の場合
                
                    
                    '10-2.合成料率・資産割合    ※親無しのみ
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strMsgSyousai = DATASHEET_GOHSEI_WARIAI
                    Call sub_GouseiWariai(strFileName _
                                        , lngRateMdfSeq _
                                        , Sisan() _
                                        , lngSisan _
                                        , lngSanteiN7Cnt _
                                        , lngKKCnt)
                           
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
                    
                    '11.料率    ※親無しのみ
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strMsgSyousai = DATASHEET_TOKUKA_GATA
                    Call sub_TokukagataRate(strFileName _
                                        , lngRateMdfSeq _
                                        , Sisan() _
                                        , lngSisan _
                                        , strKohzaList() _
                                        , lngKKCnt _
                                        , lngSanteiN7Cnt _
                                        , lngErrorCnt)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                ElseIf CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_N11 And strGassanKbn = KOHZA_GASSAN_OFF Then
                '請求書種類＝N11　かつ　合算以外
                    
                    lngN11Cnt = lngN11Cnt + 1
                
                    '「N11計算書・資産1〜4」の作成
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    Call sub_N11KsanShoSisan(strFileName _
                                            , lngRateMdfSeq _
                                            , lngN11Cnt _
                                            , Sisan() _
                                            , lngSisan _
                                            , strKohzaList() _
                                            , lngKKCnt _
                                            , DATASHEET_N11_KSAN_SHO)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                
                    '「N11計算書・資産1〜4段階」の作成
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    Call sub_N11KsanShoSisanDankai(strFileName _
                                                , lngRateMdfSeq _
                                                , lngN11Cnt _
                                                , Sisan() _
                                                , lngSisan _
                                                , strKohzaList() _
                                                , lngKKCnt _
                                                , lngErrorCnt _
                                                , DATASHEET_N11_KSAN_SHO)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
                
'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                ElseIf CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_KOKYAKU_A And strGassanKbn = KOHZA_GASSAN_OFF Then
                '請求書種類＝顧客指定Ａ　かつ　合算以外
                    
                    lngN12Cnt = lngN12Cnt + 1
                
                    '「顧客指定A計算書・資産1〜4」の作成
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    Call sub_N11KsanShoSisan(strFileName _
                                            , lngRateMdfSeq _
                                            , lngN12Cnt _
                                            , Sisan() _
                                            , lngSisan _
                                            , strKohzaList() _
                                            , lngKKCnt _
                                            , DATASHEET_A_KSAN_SHO)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                
                    '「顧客指定A計算書・資産1〜4段階」の作成
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    Call sub_N11KsanShoSisanDankai(strFileName _
                                                , lngRateMdfSeq _
                                                , lngN12Cnt _
                                                , Sisan() _
                                                , lngSisan _
                                                , strKohzaList() _
                                                , lngKKCnt _
                                                , lngErrorCnt _
                                                , DATASHEET_A_KSAN_SHO)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                End If
                
            End If
            
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
            If ((CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_DANMEN Or _
                 CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_DANMEN_A) And _
                 CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)) = strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM)) Or _
               ((CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_GANP_DANMEN_B) And _
                 CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)) <= strKohzaList(lngKKCnt, KOHZALIST_SEIKYU_YMD)) Then
                 

                '投資資産内訳書の作成
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                Call sub_UchiwakeSyoMain(strFileName _
                                        , lngRateMdfSeq _
                                        , Sisan() _
                                        , lngSisan _
                                        , strKohzaList() _
                                        , lngKKCnt _
                                        , lngErrorCnt)
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                
                
                
            End If
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
        
            '期間変更チェック用ローカル変数へのセット
            strRateTekiyoFrom = CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM))      '料率適用期間From
            strRateTekiyoTo = CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_TO))        '料率適用期間To
        
        Else
        '資産分類≠０(調整とＴ２１)
        
            If CStr(Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI)) = "A" Or CStr(Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI)) = "B" Then
            '調整資産
                lngChousei = lngChousei + 1
                
                lngChoseSisanCount = lngChoseSisanCount + 1
                
'                '調整資産期間変更順を求める
'                If (CStr(Sisan(lngSisan, 2)) <> strChoseTekiyoFrom Or _
'                    CStr(Sisan(lngSisan, 3)) <> strChoseTekiyoTo) Then
'
'                    '期間内の資産カウント
'                    lngChoseSisanCount = 1
'
''                    '調整変更順Noのインクリメント
''                    lngChoseMdfSeq = lngChoseMdfSeq + 1
'                End If
                
'------------<Modify Start azuma 2007/05/24 (PH3)> -----------------------
'''------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
''                If CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_HEIZAN Then
''                '請求書種類＝時価平残の場合のみ作成
'''------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
'------------<Modify End   azuma 2007/05/24 (PH3)> -----------------------
                
                    '3-3.(合算)請求書・調整
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    If strGassanKbn = KOHZA_GASSAN_ON Then
                    '合算
                        strSheetName = DATASHEET_G_SEIKYU_CHOSEI
                        strOffSet = CStr(lngChousei - 1 + ((lngKKCnt) * GASSAN_OFFSET_BASE))
                        strCell = DATASHEET_ITEMNAME_COL
                        strChikanMae = DATASHEET_INC_KOHZA & "01"
                        strChikanAto = DATASHEET_INC_KOHZA & Format(lngKKCnt, "00")
                    Else
                    '親無し
                        strSheetName = DATASHEET_GOHKEI2
                        
                        strOffSet = CStr(lngChousei - 1)
                        strCell = DATASHEET_ITEMNAME_COL
                        strChikanMae = ""
                        strChikanAto = ""
                    End If
                    strMsgSyousai = strSheetName
                    '＠行貼付
                    Call sub_AddSheetItemRow(strFileName _
                                           , strSheetName _
                                           , lngKKCnt _
                                           , strChikanMae _
                                           , strChikanAto _
                                           , strOffSet _
                                           , lngStartRow _
                                           , lngEndRow, strCell)
                                                           
                    '(計算期間Ｘ)の判定
                    For lngCnt = 1 To UBound(typChoseiNum)
                        With typChoseiNum(lngCnt)
                            If .strSisanBunrui = Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI) And _
                               .strSisanCode = Sisan(lngSisan, SISANLIST_SHISAN_CODE) Then
                               .lngKikan = .lngKikan + 1
                               lngChoseMdfSeq = .lngKikan
                               Exit For
                            End If
                        End With
                    Next lngCnt
                    If lngCnt > UBound(typChoseiNum) Then
                        ReDim Preserve typChoseiNum(lngCnt)
                        With typChoseiNum(lngCnt)
                            .strSisanBunrui = Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI)
                            .strSisanCode = Sisan(lngSisan, SISANLIST_SHISAN_CODE)
                            .lngKikan = 0
                            lngChoseMdfSeq = 0
                        End With
                    End If
                    
                    'MULTI項目へ期間の貼付
                    Call sub_FillinMultItem(strFileName _
                                           , DATASHEET_DATA _
                                           , lngStartRow _
                                           , lngEndRow _
                                           , DATASHEET_MULTI1_COL _
                                           , CStr(lngChoseMdfSeq + 1))
                                           
                    '条件への貼付け
                    Call sub_SetJoukenData(strFileName _
                                         , Sisan() _
                                         , lngSisan _
                                         , lngStartRow _
                                         , False)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                
'------------<Modify Start azuma 2007/05/24 (PH3)> -----------------------
''------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
'                End If  '「請求書種類＝時価平残の場合のみ作成」の終わり
''------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
'------------<Modify End   azuma 2007/05/24 (PH3)> -----------------------
                
                '8.計算書(調整資産)     ※合算でも使用
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                strMsgSyousai = DATASHEET_CHOSEI
                Call sub_ChoseiKeisan(strFileName _
                                  , (lngChoseMdfSeq + 1) _
                                  , lngChoseSisanCount _
                                  , Sisan() _
                                  , lngSisan _
                                  , strKohzaList() _
                                  , lngKKCnt _
                                  , lngErrorCnt)
                                  
                                    
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                
                If strGassanKbn = KOHZA_GASSAN_ON Then
'------------<Modify Start azuma 2006/10/20 単No.222> -----------------------
'                    '5,6.算定基礎(月末・月中)
'                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'                    strMsgSyousai = DATASHEET_G_KISO_SUCHI1 & " " & DATASHEET_G_KISO_SUCHI2
'                    '＠資産分類＝０の全ての資産で行貼付
'                    Call sub_GKeisanKiso(strFileName _
'                                      , (lngChoseMdfSeq + 1) _
'                                      , lngChoseSisanCount _
'                                      , Sisan() _
'                                      , lngSisan _
'                                      , strKohzaList() _
'                                      , lngKKCnt)
'                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'------------<Modify End   azuma 2006/10/20 単No.222> -----------------------
'------------<Modify Start azuma 2006/11/17 > -----------------------
                    strMsgSyousai = DATASHEET_KISO_SUCHI1 & " " & DATASHEET_KISO_SUCHI2
                    '＠資産分類＝０の全ての資産で行貼付
                    Call sub_KeisanKiso(strFileName _
                                      , (lngChoseMdfSeq + 1) _
                                      , lngChoseSisanCount _
                                      , Sisan() _
                                      , lngSisan _
                                      , strKohzaList() _
                                      , lngKKCnt _
                                      , lngErrorCnt)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'------------<Modify End   azuma 2006/11/17 > -----------------------
                
                Else
                    '5,6.算定基礎(月末・月中)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    lngSanteiCnt = 1
                    strMsgSyousai = DATASHEET_KISO_SUCHI1 & " " & DATASHEET_KISO_SUCHI2
                    '＠資産分類＝０の全ての資産で行貼付
                    Call sub_KeisanKiso(strFileName _
                                      , (lngChoseMdfSeq + 1) _
                                      , lngChoseSisanCount _
                                      , Sisan() _
                                      , lngSisan _
                                      , strKohzaList() _
                                      , lngKKCnt _
                                      , lngErrorCnt)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                End If
                
                
                '期間変更チェック用ローカル変数へのセット
                strChoseTekiyoFrom = CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM))     '調整適用期間From
                strChoseTekiyoTo = CStr(Sisan(lngSisan, SISANLIST_RATE_KIKAN_TO))       '調整適用期間To
            
            ElseIf CStr(Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI)) = "Z" Then
            'Ｔ２１資産
                
'------------<Modify Start azuma 2007/05/24 (PH3)> -----------------------
'''------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
''                If CStr(Sisan(lngSisan, SISANLIST_SEIKYUSHO_SHURUI)) = SHURUI_JIKA_HEIZAN Then
''                '請求書種類＝時価平残の場合のみ作成
'''------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
'------------<Modify End   azuma 2007/05/24 (PH3)> -----------------------
                
                    '請求書の自己設定委託者報酬額  ※１子口座で1回だけ貼付る。
                    If blnJikosettei = False Then
    
                        If strGassanKbn = KOHZA_GASSAN_ON Then
                        '合算
                        
                            '「合算請求書・自己」の貼付　（自己設定委託者報酬額）
                            '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    '------------<Modify Start azuma 2006/10/20 単No.223> -----------------------
                            Call sub_AddSheetItemRow(strFileName _
                                                   , DATASHEET_G_SEIKYU_JIKO _
                                                   , lngKKCnt _
                                                   , DATASHEET_INC_KOHZA & "01" _
                                                   , DATASHEET_INC_KOHZA & Format(lngKKCnt, "00") _
                                                   , (lngKKCnt) * GASSAN_OFFSET_BASE _
                                                   , lngStartRow _
                                                   , lngEndRow _
                                                   , DATASHEET_ITEMNAME_COL)
    '                        Call sub_AddSheetItemRow(strFileName _
    '                                               , DATASHEET_G_SEIKYU_JIKO _
    '                                               , lngKKCnt _
    '                                               , "" _
    '                                               , "" _
    '                                               , (lngKKCnt) * GASSAN_OFFSET_BASE _
    '                                               , lngStartRow _
    '                                               , lngEndRow)
    '------------<Modify End   azuma 2006/10/20 単No.223> -----------------------
                            '条件への貼付け
                            Call sub_SetJoukenData(strFileName, Sisan(), 0, lngStartRow)
                            '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        Else
                        '親無し
                        
                            '「請求書・自己」の貼付　（自己設定委託者報酬額）
                            '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                            Call sub_AddSheetItemRow(strFileName _
                                                   , DATASHEET_GOHKEI3 _
                                                   , lngKKCnt _
                                                   , "" _
                                                   , "" _
                                                   , "" _
                                                   , lngStartRow _
                                                   , lngEndRow)
                            '条件への貼付け
                            Call sub_SetJoukenData(strFileName, Sisan(), 0, lngStartRow, True)
                        End If
                    
                        
                        '貼付済みフラグ設定
                        blnJikosettei = True
                    End If

'------------<Modify Start azuma 2007/05/24 (PH3)> -----------------------
'''------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
''                End If  '「請求書種類＝時価平残の場合のみ作成」の終わり
'''------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
'------------<Modify End   azuma 2007/05/24 (PH3)> -----------------------

                '自己設定投信       ※合算でも使用
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                
                lngT21Cnt = lngT21Cnt + 1
'------------<Modify Start azuma 2006/12/28 > -----------------------
                '自己設定投信は料率適用期間が離れていても同じ資産を一覧に出力しないらしい
                
                strBuff = ""
                strBuff = CStr(Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI)) & CStr(Sisan(lngSisan, SISANLIST_SHISAN_CODE))
                
                If dicT21SISAN.exists(strBuff) = False Then
                    dicT21SISAN.Add strBuff, strBuff
'------------<Modify End   azuma 2006/12/28 > -----------------------
                
                    strMsgSyousai = DATASHEET_T21SISAN
'                    lngT21Cnt = lngT21Cnt + 1
                    Call sub_T21JikoSettei(strFileName _
                                        , lngRateMdfSeq _
                                        , Sisan() _
                                        , lngSisan _
                                        , lngT21Cnt _
                                        , lngKKCnt)
                End If
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
            
                'Ｔ２１明細         ※合算でも使用
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                strMsgSyousai = DATASHEET_T21_MEISAI
                Call sub_T21Meisai(strFileName _
                                    , lngRateMdfSeq _
                                    , Sisan() _
                                    , lngSisan _
                                    , strKohzaList() _
                                    , lngKKCnt _
                                    , lngT21Cnt _
                                    , lngErrorCnt)
                '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
            
            End If
        
        End If


    Next lngSisan
    
        
    '出力パラメータの設定
    typTorikomi.lngChoseSisanId = lngChousei        '調整資産数
    typTorikomi.lngJikoSeteiId = lngT21Cnt          '自己設定投信(T21資産)数
    
    
'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
'「書類送付のご案内」を資産ループの上に移動
'    '「書類送付のご案内」の貼付
'    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
''------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
'    If lngKKCnt = 1 Then
''    If lngKKCnt = UBound(typKohzaList(lngKohzaCnt).strKohzaList) Then
''------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
'
'        strMsgSyousai = DATASHEET_SOUFU
'        Call sub_AddSheetItemRow(strFileName _
'                               , DATASHEET_SOUFU _
'                               , lngKKCnt _
'                               , "" _
'                               , "" _
'                               , "" _
'                               , lngStartRow _
'                               , lngEndRow)
'
'
''------------<Modify Start azuma 2006/10/25 連No.54> -----------------------
''''        Call sub_Syorui2(strGassanKbn, strSyoruiOut)
'
'
'
''''        '作成する書類の行増幅
''''        Call sub_RowIncrement(strFileName _
''''                            , lngStartRow _
''''                            , lngEndRow _
''''                            , DATASHEET_INC_SHORUI & DATASHEET_INC_XX & DATASHEET_ANNAI_SYORUI_VAL _
''''                            , strSyoruiOut())
''------------<Modify End   azuma 2006/10/25 連No.54> -----------------------
'    End If
'
'
'
'    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
    
    lngEndRow = func_GetEndRow(strFileName, DATASHEET_DATA)
    '*** ()で囲まれた文字列の置換
    Call sub_ReplaceKeyItem(strFileName, strKohzaList(), lngKKCnt, 1, lngEndRow)
            
            
    Set dicT21SISAN = Nothing
    
    func_DataFileCustomize = True
    Exit Function

ErrHandler:

    func_DataFileCustomize = False
'Resume
    With gusrErr
        .ModuleId = MODULE_NAME         'モージュールID
        .Procedure = PROCEDURE_NAME     'プロシージャID
        .MsgCode = ERR_MSGCD_VB         'メッセージ区分
        .ErrNum = Err.Number            'システムエラーコード
        .ErrDescript = Err.Description  'システムエラー内容
        .KohzaNo = strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
        .MsgNaiyou = "データシート作成中システムエラー"        'メッセージ内容(ブックファイル名)
        'メッセージ詳細
        .MsgSyousai = "デートシートの行貼付け・行増幅中にシステムエラーが発生しました。" & _
             vbCrLf & "システム管理者に連絡して下さい。" & _
             vbCrLf & "作成中書類名   :" & strMsgSyousai & _
             vbCrLf & "テンプレートファイル   :" & strFileName & _
             vbCrLf & "口座番号       :" & strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO) & _
             vbCrLf & "請求期間ID     :" & strKohzaList(lngKKCnt, KOHZALIST_SEIKYU_KIKAN_ID) & _
             vbCrLf & "資産分類       :" & Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI) & _
             vbCrLf & "資産コード     :" & Sisan(lngSisan, SISANLIST_SHISAN_CODE)
        'エラーシート書き込み
        Call fncWriteErrSheet(ERROR_SHEETNAME)
    End With
    lngErrorCnt = lngErrorCnt + 1
    
    Set dicT21SISAN = Nothing

'---- Error Log Start ----------------------------------------------------
'    Dim lng As Long
'    lng = Err.Number
'    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "func_DataFileCustomize", Err.Number, Err.Description)
'    On Error GoTo 0
    'ワークブックを閉じる
'    Workbooks(strFileName).Close SaveChanges:=False

'    Err.Raise lng
'---- Error Log End   ----------------------------------------------------


End Function


'
'*************************************************************************
'関数名　　：データシートに指定された資産の列を追加する。
'
'引　　数　：
'           strbookName     I       コピー元ブック
'           strSheetName    I       コピー元シート
'           lngKKCnt        I       子口座のインデックス番号
'           strChikanMae    I       シート名の置換検索文字
'           strChikanAto    I       シート名の置換文字
'           strOffSet       I       行番号にせっていする
'           lngStartRow     O       開始行
'           lngEndRow       O       終了行
'           strCellName     I       置換列セル
'           lngDelStRow     I       削除開始行
'           lngDelEdRow     O       削除終了行
'
'
'戻り値　　：
'
'機能説明　：データシートに指定された資産の列を追加する。
'
'更新履歴　：2006/08/09 SRA Y.Azuma    新規作成
'
'*************************************************************************
Public Sub sub_AddSheetItemRow(ByVal strBookName As String _
                              , ByVal strSheetName As String _
                              , ByVal lngKKCnt As Long _
                              , ByRef strChikanMae As String _
                              , ByRef strChikanAto As String _
                              , ByRef strOffSet As String _
                              , ByRef lngStartRow As Long _
                              , ByRef lngEndRow As Long _
                              , Optional ByVal strCellName As String = "" _
                              , Optional ByVal lngDelStRow As Long = 0 _
                              , Optional ByVal lngDelEdRow As Long = 0)
    
    Const PROCEDURE_NAME = "sub_AddSheetItemRow"
    Dim lngTmpStartRow      As Long
    Dim lngTmpEndRow        As Long
    
    'テンプレートシートの開始行を求める
    lngTmpStartRow = func_GetStartRow(strBookName, DATASHEET_TEMP_DATA, strSheetName)
    
    'テンプレートシートの最終行を求める
    lngTmpEndRow = func_GetEndRow(strBookName, DATASHEET_TEMP_DATA, strSheetName)
    
    'データシートへの列の追加処理とA列名変更
    Call sub_RowCopyPast(strBookName _
                        , DATASHEET_TEMP_DATA _
                        , lngTmpStartRow _
                        , lngTmpEndRow _
                        , DATASHEET_DATA _
                        , strChikanMae _
                        , strChikanAto _
                        , strOffSet _
                        , lngStartRow _
                        , lngEndRow _
                        , strCellName)
                        
    '指定行を削除する。
    If lngDelStRow <> 0 And lngDelEdRow <> 0 And lngDelStRow <= lngDelEdRow Then
        With Workbooks(strBookName).Worksheets(DATASHEET_DATA)
            .Range(lngStartRow + lngDelStRow & ":" & lngStartRow + lngDelEdRow).Delete Shift:=xlUp
        End With
        lngEndRow = lngEndRow - (lngDelEdRow - lngDelStRow + 1)
    End If
                        
    
'------------<Modify Start azuma 2006/10/25 連No.54> -----------------------
'''    With typSakuseiSyorui(lngKKCnt)
'''
'''        '既に登録済みかチェックして未登録なら登録処理を行う
'''        If dicShoruiList.exists(strSheetName) = False Then
'''
'''            .lngListCnt = .lngListCnt + 1
'''            ReDim Preserve .strShoruiList(.lngListCnt)
'''
'''            'ディクショナリーに追加
'''            dicShoruiList.Add strSheetName, strSheetName
'''            .strShoruiList(.lngListCnt) = strSheetName
'''        End If
'''    End With
'------------<Modify End   azuma 2006/10/25 連No.54> -----------------------

End Sub
'
'*************************************************************************
'関数名　　：列先頭取得関数
'
'引　　数　：
'           strbookName     I       対象ブック
'           strSheetName    I       対象シート
'           strName         I       検索する名前
'
'戻り値　　：行番号
'
'機能説明　：指定されたワークシートの列の先頭を求める
'
'更新履歴　：2006/08/11 SRA Y.Azuma    新規作成
'
'*************************************************************************
Private Function func_GetStartRow(ByVal strBookName As String _
                                , ByVal strSheetName As String _
                                , ByVal strName As String) As Long
    Dim lngRowCnt As Long
    Dim lngRowEnd As Long
    
    lngRowEnd = func_GetEndRow(strBookName, strSheetName)
    
    With Workbooks(strBookName).Worksheets(strSheetName)
        For lngRowCnt = 1 To lngRowEnd
            If .Range(DATASHEET_SHEETNAME_COL & lngRowCnt).Value = strName Then
                Exit For
            End If
        Next lngRowCnt
    End With
    
    func_GetStartRow = lngRowCnt
    
End Function


'
'*************************************************************************
'関数名　　：末行取得関数
'
'引　　数　：
'           strbookName     I       対象ブック
'           strSheetName    I       対象シート
'           strName         I       検索する名前
'
'戻り値　　：行番号
'
'機能説明　：指定されたワークシートの列の最後行を求める
'
'更新履歴　：2006/08/11 SRA Y.Azuma    新規作成
'
'*************************************************************************
Public Function func_GetEndRow(ByVal strBookName As String _
                              , ByVal strSheetName As String _
                              , Optional ByVal strName As String = "") As Long
    
    Dim lngRowCnt As Long
    Dim lngRowEnd As Long
    
    lngRowEnd = Workbooks(strBookName).Worksheets(strSheetName).Range(DATASHEET_ITEMNAME_COL & "65536").End(xlUp).Row
    
    If Trim(strName) = "" Then
        If lngRowEnd = 1 Then
            lngRowEnd = 0
        End If
        func_GetEndRow = lngRowEnd
    Else
        With Workbooks(strBookName).Worksheets(strSheetName)
            For lngRowCnt = lngRowEnd + 1 To 1 Step -1
                If Trim(.Range(DATASHEET_SHEETNAME_COL & lngRowCnt).Text) = Trim(strName) Then
                    Exit For
                End If
            Next lngRowCnt
        End With
        func_GetEndRow = lngRowCnt
    End If
    
    
End Function

'
'*************************************************************************
'関数名　　：行コピー処理
'
'引　　数　：
'           strCpyBookName      I       コピー元ブック名
'           strCpySheetName     I       コピー元シート名
'           lngCpyStartRow      I       コピー範囲開始行
'           lngCpyEndRow        I       コピー範囲終了行
'           strPstSheetName     I       貼付シート名
'           strChikanMae        I       置換前文字列
'           strChikanAto        I       置換後文字列
'           strOffSet           I       行数(オフセット)
'           lngStartRow         O       貼付範囲開始行
'           lngEndRow           O       貼付範囲終了行
'           strCellName         I       置換列
'
'戻り値　　：なし
'
'機能説明　：コピー元シートの指定行(開始、終了)をコピーし
'           コピー先シートの最終行へ貼り付ける。Ａ列の名称変更する。
'
'更新履歴　：2006/08/25 SRA Y.Azuma    新規作成
'
'*************************************************************************
Private Sub sub_RowCopyPast(ByVal strCpyBookName As String _
                          , ByVal strCpySheetName As String _
                          , ByVal lngCpyStartRow As Long _
                          , ByVal lngCpyEndRow As Long _
                          , ByVal strPstSheetName As String _
                          , ByRef strChikanMae As String _
                          , ByRef strChikanAto As String _
                          , ByRef strOffSet As String _
                          , ByRef lngStartRow As Long _
                          , ByRef lngEndRow As Long _
                          , ByVal strCellName As String)
                          
    
    Dim lngPastRow      As Long
    Dim lngPastNum      As Long
    Dim lngRow          As Long
    Dim strCell         As String
    
    '元シートからコピー
    Workbooks(strCpyBookName).Worksheets(strCpySheetName).Rows(lngCpyStartRow & ":" & lngCpyEndRow).Copy
    
    'シートの終端(空行位置)を求める
    lngPastRow = func_GetEndRow(strCpyBookName, strPstSheetName) + 1
    
    lngStartRow = lngPastRow                '貼付け開始行
    
    'シートに貼付け
    Workbooks(strCpyBookName).Sheets(strPstSheetName).Rows(lngPastRow & ":" & lngPastRow).Insert Shift:=xlDown

    '貼り付けた行数
    lngPastNum = lngCpyEndRow - lngCpyStartRow + 1
     
    lngEndRow = lngStartRow + lngPastNum - 1  '貼付け終了行

    '置換前文字列がNULLでない場合、置換後文字列で置換する。
    If Trim(strCellName) = "" Then
        strCell = DATASHEET_SHEETHEAD_COL      'ヘッダ部を置換
    Else
        strCell = strCellName
    End If
        
    Workbooks(strCpyBookName).Sheets(strPstSheetName). _
        Range(strCell & lngPastRow & ":" & DATASHEET_SHEETHEAD_COL & lngPastRow + lngPastNum).Replace _
        What:=strChikanMae, Replacement:=strChikanAto, LookAt:=xlPart, _
        SearchOrder:=xlByRows, MatchCase:=False
    
    
    '行数(オフセット)がNULLでない場合、行数にオフセット値を代入する。
    If Trim(strOffSet) <> "" Then
        For lngRow = lngStartRow To lngEndRow
            Workbooks(strCpyBookName).Sheets(strPstSheetName).Range(DATASHEET_OFFSET_COL & lngRow).Value = strOffSet
        Next lngRow
    End If
    
End Sub


'*************************************************************************
'関数名　　：条件の貼付け処理
'
'引　　数　：
'           strFileName     I       データシートファイル名
'           Sisan()         I       資産データ配列
'           lngSisan        I       資産データ配列の該当インデックス
'           lngRow          I       条件を設定する行
'           blnZentai       I       全体フラグ(分類コード'0'資産コード'0000'で取得したいときTrue)
'
'戻り値　　：なし
'
'機能説明　：データシート「条件」行に資産分類、資産コード、適用期間ＩＤ、
'           適用期間From、Toの設定を行う。
'
'更新履歴　：2006/08/25 SRA Y.Azuma    新規作成
'
'*************************************************************************
Public Sub sub_SetJoukenData(ByVal strFileName As String _
                            , ByRef Sisan() As Variant _
                            , ByVal lngSisan As Long _
                            , ByVal lngRow As Long _
                            , Optional ByVal blnZentai As Boolean = False)
                            
    
    Dim strSisanBunrui      As String
    Dim strSisanCode        As String
    Dim strSisanCodeAll     As String
    Dim strRateKikanId      As String
    Dim strRateKikanFrom    As String
    Dim strRateKikanTo      As String
    Dim lngEnd              As Long
    Dim lngCnt              As Long
    Dim strWhat             As String
    Dim strReplace          As String

    With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
        If blnZentai = False Then
'        '各資産ごと
            strSisanBunrui = Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI)
            strSisanCode = Sisan(lngSisan, SISANLIST_SHISAN_CODE)
            strSisanCodeAll = Sisan(lngSisan, SISANLIST_SHISAN_CODE)
        Else
'        '適用期間内の全資産の合計
            strSisanBunrui = Sisan(lngSisan, SISANLIST_SHISAN_BUNRUI)
            strSisanCode = Sisan(lngSisan, SISANLIST_SHISAN_CODE)
            strSisanCodeAll = "0000"
        End If
        strRateKikanId = Sisan(lngSisan, SISANLIST_RATE_KIKAN_ID)
        strRateKikanFrom = Sisan(lngSisan, SISANLIST_RATE_KIKAN_FROM)
        strRateKikanTo = Sisan(lngSisan, SISANLIST_RATE_KIKAN_TO)
        
        lngEnd = func_GetEndRow(strFileName, DATASHEET_DATA)
        
        For lngCnt = 1 To 6
            strWhat = ""
            strReplace = ""
            Select Case lngCnt
                Case 1
                    strWhat = "(資産分類)"
                    strReplace = strSisanBunrui
                Case 2
                    strWhat = "(資産コード)"
                    strReplace = strSisanCode
                Case 3
                    strWhat = "(料率適用期間ＩＤ)"
                    strReplace = strRateKikanId
                Case 4
                    strWhat = "(料率適用期間Ｆｒｏｍ)"
                    strReplace = strRateKikanFrom
                Case 5
                    strWhat = "(料率適用期間Ｔｏ)"
                    strReplace = strRateKikanTo
                Case 6
                    strWhat = "(資産コード全体)"
                    strReplace = strSisanCodeAll
            End Select
        
            Workbooks(strFileName).Worksheets(DATASHEET_DATA). _
                Range(lngRow & ":" & lngEnd).Replace _
                What:=strWhat, Replacement:="'" & strReplace, LookAt:=xlPart, _
                SearchOrder:=xlByRows, MatchCase:=False
        
        Next lngCnt
    End With

End Sub


'*************************************************************************
'関数名　　：データシート固定情報の設定
'
'引　　数　：
'           strFileName     I       データシートファイル名
'           strKohzaList()  I       処理対象口座情報配列
'           lngKohzaCnt     I       処理対象口座情報配列の対象インデックス
'           lngStartRow     I       置換範囲開始行
'           lngEndRow       I       置換範囲終了行
'
'戻り値　　：なし
'
'機能説明　：指定範囲内の「(＠＠＠)文字」を実際の値に置換する。
'
'更新履歴　：2006/08/25 SRA Y.Azuma    新規作成
'更新履歴　：2007/03/29 SRA Y.Azuma    変更     (PH3)PH3請求書作成の対応
'更新履歴　：2007/07/31 SRA Y.Azuma    変更     (PH3.5)PH3.5機能追加
'
'*************************************************************************
Public Sub sub_ReplaceKeyItem(ByVal strFileName As String _
                             , ByRef strKohzaList() As String _
                             , ByVal lngKohzaCnt As Long _
                             , ByVal lngStartRow As Long _
                             , ByVal lngEndRow As Long)

    
    Dim lngCnt          As Long
    Dim strOldName         As String
    Dim strNewName      As String
    
    For lngCnt = 0 To 7

        Select Case lngCnt
        Case 0
        '（口座番号）
            strOldName = "(口座番号)"
            strNewName = "'" & strKohzaList(lngKohzaCnt, KOHZALIST_KOHZA_NO)
        Case 1
        '（請求期間ID）
            strOldName = "(請求期間ID)"
            strNewName = strKohzaList(lngKohzaCnt, KOHZALIST_SEIKYU_KIKAN_ID)
        Case 2
        '（請求書期間To）
            strOldName = "(請求書期間To)"
            strNewName = strKohzaList(lngKohzaCnt, KOHZALIST_SEIKYUSHO_KIKAN_TO)
        Case 3
        '（請求日）
            strOldName = "(請求日)"
            strNewName = strKohzaList(lngKohzaCnt, KOHZALIST_SEIKYU_YMD)
        Case 4
        '（日付種類）
            strOldName = "(日付種類)"
            strNewName = strKohzaList(lngKohzaCnt, KOHZALIST_HIZUKE_SHURUI)
        Case 5
        '（親口座番号）
            strOldName = "(親口座番号)"
            strNewName = "'" & strKohzaList(lngKohzaCnt, KOHZALIST_OYA_KOHZA_NO)
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
        Case 6
        '（請求書期間From）
            strOldName = "(請求書期間From)"
            strNewName = strKohzaList(lngKohzaCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM)
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
        
'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
        Case 7
        '(顧問料計算基準日)
            strOldName = "(顧問料計算基準日)"
            strNewName = strKohzaList(lngKohzaCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM)
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
        End Select
        
        With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
            .Rows(lngStartRow & ":" & lngEndRow).Replace What:=strOldName, Replacement:=strNewName _
                , LookAt:=xlWhole, SearchOrder:=xlByRows, MatchCase:=True
        End With
    Next lngCnt

End Sub

'*************************************************************************
'関数名　　：丸数値文字変換関数
'
'引　　数　：
'           lngNum      I       削除対象
'
'戻り値　　：変換後文字列
'
'機能説明　：１〜２０の数値を丸数値文字へ変換する。
'
'更新履歴　：2006/08/25 SRA Y.Azuma    新規作成
'
'*************************************************************************
Public Function func_ExchMarusuchi(ByVal lngNum As Long) As String
    If lngNum > 20 Or lngNum < 1 Then
        func_ExchMarusuchi = lngNum
        Exit Function
    Else
        func_ExchMarusuchi = Choose(lngNum, "@", "A", "B", "C", "D" _
                                          , "E", "F", "G", "H", "I" _
                                          , "J", "K", "L", "M", "N" _
                                          , "O", "P", "Q", "R", "S")
    End If
End Function


'
'*************************************************************************
'関数名　　：データ取得処理
'
'引　　数　：
'           strFileName         I       データシートファイル名
'           strKohzaList()      I       処理対象口座情報配列
'           lngKohzaCnt         I       処理対象口座情報配列の該当添え字
'           strNamInfo()        I       NAM情報(EXCELファイルから読み込んだもの)
'           typKohzaList()      I       合算口座構造体
'           lngKohzaCnt         I       合算口座構造体の添え字
'           typTorikomi         I       料率変更構造体
'           lngErrorCnt         O       エラー数
'
'戻り値　　：Boolean
'
'機能説明　：データシートを毎行毎に処理する。
'
'更新履歴　：2006/08/25 SRA Y.Azuma    新規作成
'更新履歴　：2006/10/20 SRA Y.Azuma    変更     「(計算期間@)」の出力(単No.225)
'更新履歴　：2006/11/06 SRA Y.Azuma    変更     性能改善1
'更新履歴　：2006/11/17 SRA Y.Azuma    変更     T21明細の期間表示変更
'更新履歴　：2007/01/24 SRA Y.Azuma    変更     (PH2)口座属性がない場合の対応
'更新履歴　：2007/03/29 SRA Y.Azuma    変更     (PH3)PH3請求書作成の対応
'更新履歴　：2007/04/12 SRA Y.Azuma    変更     (PH2)T21明細月末開始対応
'更新履歴　：2007/04/17 SRA Y.Azuma    変更     (PH3)消費税率取得方法の統一
'更新履歴　：2007/04/20 SRA Y.Azuma    変更     (PH3)単体障害対応
'更新履歴　：2007/07/31 SRA Y.Azuma    変更     (PH3.5)PH3.5機能追加
'
'*************************************************************************
Private Function func_CompleteDataFile(ByVal strFileName As String _
                                     , ByRef strKohzaList() As String _
                                     , ByVal lngKKCnt As Long _
                                     , ByRef strNamInfo() As String _
                                     , ByRef typKohzaList() As typKohzaMain _
                                     , ByVal lngKohzaCnt As Long _
                                     , ByRef typTorikomi As TorikomiOutput _
                                     , ByRef lngErrorCnt As Long _
                                     , Optional lngStartRow As Long = 1) As Boolean
On Error GoTo ErrHandler

    Const PROCEDURE_NAME = "func_CompleteDataFile"
    
    
    Dim blnRet                      As Boolean  '処理結果
    Dim lngCnt                      As Long     '汎用カウンタ
    Dim strBuff                     As String   '汎用バッファ
    Dim lngEndRows                  As Long     '処理終了行番号
    Dim lngCurRows                  As Long     '処理対象行番号(カウンタ)
'    Dim lngErrorCnt                 As Long     'エラーカウンタ
    
    
    Dim strRate_tekiyoh_kikan_from  As String   '(ローカル変数)料率適用期間From
    Dim strRate_tekiyoh_kikan_to    As String   '(ローカル変数)料率適用期間To
    Dim strSantei_kikan_from        As String   '(ローカル変数)算定期間From
    Dim strSantei_kikan_to          As String   '(ローカル変数)算定期間To
    
    Dim strSql                      As String   'Sql
    Dim strFilter                   As String   'フィルター
    Dim vdata()                     As Variant
    Dim lngCol                      As Long
    Dim lngRow                      As Long
    
    Dim strZeiRitsu                 As String   '消費税率
    Dim strRateMdfSeq               As String
'    Dim lngRateMdfSeq               As Long     '料率変更順No
    Dim lngKikan                    As Long     '計算書、請求書の「期間」
    Dim strKikan                    As String
    Dim lngIchi                     As Long
    Dim strKikanDumy                As String
    
'------------<Modify Start azuma 2006/10/26 > -----------------------
    '調整資産の計算期間　出力チェック用
    Dim strShisanBunrui             As String
    Dim strShisanCd                 As String
    Dim lngSisanCnt                 As Long
    Dim lngSameCnt                  As Long
'------------<Modify End   azuma 2006/10/26 > -----------------------
    
    Dim lngKikanFromRow             As Long
    Dim lngKikanToRow               As Long
    
    Dim Result                      As TypSaitei
    
    
    func_CompleteDataFile = False
    
'    lngRateMdfSeq = 0
'    lngSeikyusyoSeq = 0
'    lngErrorCnt = 0
    
    
    
    '消費税率の取得
'------------<Modify Start azuma 2007/04/17 (PH3)> -----------------------
    strZeiRitsu = func_GetShouhiZei(typKohzaList(lngKohzaCnt).strKohzaList _
                                  , lngKKCnt)
'    strZeiRitsu = func_GetShouhiZei
'------------<Modify End   azuma 2007/04/17 (PH3)> -----------------------
    
    
    'シートの最終行取得
    lngEndRows = func_GetEndRow(strFileName, DATASHEET_DATA)
    
    With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
    
        '明細行分繰り返し
        For lngCurRows = lngStartRow To lngEndRows
        
'            If Trim(.Range(DATASHEET_RESULT_COL & lngCurRows).Text) = "" Then
            Select Case .Range(DATASHEET_DATA_TYPE & lngCurRows).Value
            Case "条件"
            '「条件」の場合
                strRate_tekiyoh_kikan_from = .Range(RATE_TEKIYOH_KIKAN_FROM_COL & lngCurRows).Value '(ローカル変数)料率適用期間From
                strRate_tekiyoh_kikan_to = .Range(RATE_TEKIYOH_KIKAN_TO_COL & lngCurRows).Value     '(ローカル変数)料率適用期間To
            
                'a-2)算定期間を求める
                ' 算定適用期間From
                If strRate_tekiyoh_kikan_from > strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM) Then
                    strSantei_kikan_from = strRate_tekiyoh_kikan_from
                Else
                    strSantei_kikan_from = strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM)
                End If
                
                '　算定適用期間To
                If strRate_tekiyoh_kikan_to < strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_TO) Then
                    strSantei_kikan_to = strRate_tekiyoh_kikan_to
                Else
                    strSantei_kikan_to = strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_TO)
                End If
                
                
            Case "FILE"
            
                For lngCnt = 1 To UBound(strNamInfo)
                    
                    'カラム名とNAM情報のカラム名が一致した値を結果に設定する。
                    If strNamInfo(lngCnt, 0) = .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value Then
                        .Range(DATASHEET_RESULT_COL & lngCurRows).Value = strNamInfo(lngCnt, 1)
                    End If
                Next lngCnt
            
            Case "検索"
                    
                'SQLの作成
                strSql = ""
                Call sub_MakeDataSheetSql(strFileName, lngCurRows, strSql, strFilter)
                If Trim(strSql) = "" Then
                    With gusrErr
                        .ModuleId = MODULE_NAME         'モージュールID
                        .Procedure = PROCEDURE_NAME     'プロシージャID
                        .MsgCode = ERR_MSGCD_VB         'メッセージ区分
                        .ErrNum = Err.Number            'システムエラーコード
                        .ErrDescript = Err.Description  'システムエラー内容
                        .KohzaNo = strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
                        .MsgNaiyou = "データシートSQLエラー"        'メッセージ内容
                        With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
                        gusrErr.MsgSyousai = "データシートから作成したSQLがありません。 " _
                                        & "テンプレートを確認して下さい。" & vbCrLf _
                                        & "ファイル名　：" & strFileName & vbCrLf _
                                        & "行番号　　　：" & lngCurRows & "行目" & vbCrLf _
                                        & "シート名　　：" & .Range(DATASHEET_SHEETHEAD_COL & lngCurRows).Text _
                                                           & .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Text & vbCrLf _
                                        & "カラム名　　：" & .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Text
                        End With
                        'エラーシート書き込み
                        Call fncWriteErrSheet(ERROR_SHEETNAME)
                        lngErrorCnt = lngErrorCnt + 1
                    End With
                End If
                
                'データ取得
                If Trim(strSql) <> "" Then
                    Call gclsDB.DoExequteSql(gcSELECT, strSql, vdata, lngCol, lngRow)
                    
'------------<Modify Start azuma 2007/01/24 > -----------------------
Dim strTableName As String
                    With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
                        'テーブル名の取得
                        strTableName = .Range(DATASHEET_TID_COL & lngCurRows).Text
                    End With
                    
                    strTableName = CStr(StrConv(strTableName, vbUpperCase))
                    
                    '口座属性(KYK_KOHZA_ZOKUSEI)は必ずあるとは限らない為
                    'データなしの場合はエラーとしない
                    If strTableName = TBL_KOHZA_ZOKUSEI And lngRow = 0 Then
                        ReDim vdata(0, 0)
                        vdata(0, 0) = ""
                        lngRow = 1
                    End If
'------------<Modify End   azuma 2007/01/24 > -----------------------
                    If lngRow = 0 Then
                    'データなし
                        Erase vdata
                        With gusrErr
                            .ModuleId = MODULE_NAME         'モージュールID
                            .Procedure = PROCEDURE_NAME     'プロシージャID
                            .MsgCode = ERR_MSGCD_VB         'メッセージ区分
                            .ErrNum = Err.Number            'システムエラーコード
                            .ErrDescript = Err.Description  'システムエラー内容
                            .KohzaNo = strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
                            .MsgNaiyou = "データシートSQLエラー"        'メッセージ内容(ブックファイル名)
                            With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
                            gusrErr.MsgSyousai = "データシートから作成したSQLの結果が０件でした。" & vbCrLf _
                                        & "作成されたデータシートの該当行を確認して下さい。" & vbCrLf _
                                        & "ファイル名：" & strFileName & vbCrLf _
                                        & "処理行　　：" & lngCurRows & "行目" & vbCrLf _
                                        & "シート名　：" & .Range(DATASHEET_SHEETHEAD_COL & lngCurRows).Text _
                                                         & .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Text & vbCrLf _
                                        & "カラム名  ：" & .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Text & vbCrLf _
                                        & "ＳＱＬ文　：" & strSql                'メッセージ詳細
                            End With
                            'エラーシート書き込み
                            Call fncWriteErrSheet(ERROR_SHEETNAME)
                            lngErrorCnt = lngErrorCnt + 1
                        End With
                    Else
                    'データあり
                        .Range(DATASHEET_RESULT_COL & lngCurRows).Value = "" & Trim(CStr(vdata(0, 0)))
                    End If
                End If
                strSql = ""
        
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                'T21明細の場合、期間Fromと期間Toの行を変数に退避する。(T21明細の”変数”で期間From、To計算に使う)
                If .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Text = DATASHEET_T21_MEISAI Then
                    If .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Text = DATASHEET_T21_MEISAI_KIKAN_FROM_VAL Then
                        lngKikanFromRow = lngCurRows
                    End If
                   
                    If .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Text = DATASHEET_T21_MEISAI_KIKAN_TO_VAL Then
                        lngKikanToRow = lngCurRows
                    End If
                   
                End If
                
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
        
            Case "変数"
                
                strRateMdfSeq = Replace(.Range(DATASHEET_SHEETHEAD_COL & lngCurRows).Value, DATASHEET_INC_KIKAN, "")
'                If IsNumeric(strRateMdfSeq) Then
'                    lngRateMdfSeq = CLng(strRateMdfSeq)
'                Else
'                    lngRateMdfSeq = 0
'                End If
                
                Select Case .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value
                    
                Case DATASHEET_SISAN_ZENTAI_VAL     ' 期間
                    lngIchi = InStr(1, .Range(DATASHEET_SHEETHEAD_COL & lngCurRows).Value, DATASHEET_INC_KIKAN)
                    strKikanDumy = Mid(.Range(DATASHEET_SHEETHEAD_COL & lngCurRows).Value, lngIchi, 5)
                    strKikan = Replace(strKikanDumy, DATASHEET_INC_KIKAN, "")
                    If strKikan = "000" Then
                        strBuff = "''"
                    Else
                        lngKikan = CLng(strKikan)
                        strBuff = "(" & KEISAN_KIKAN & func_ExchMarusuchi(lngKikan) & ")"
                    End If
                    
                    '期間が一つしかない場合は、期間文字を表示しない
''------------<Modify Start azuma 2007/03/08 > -----------------------
                    If .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_ZENTAI Or _
                       .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_KAKEME_TYPE1 Or _
                       .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_KAKEME_TYPE3 Or _
                       .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_DANMEN_KEISAN_SHO Or _
                       .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_NICHIJI_RATE Or _
                       .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_NICHIJI_KSAN_SHO Then
'                    If .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_ZENTAI Or _
'                       .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_KAKEME_TYPE1 Or _
'                       .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_KAKEME_TYPE3 Or _
'                       .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_DANMEN_KEISAN_SHO Then
''                    If .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_ZENTAI Then
'                    '総計算書
''------------<Modify End   azuma 2007/03/08 > -----------------------
                        
'                        If .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_ZENTAI Then
'                        '総計算書の場合
                        
                        '期間変更回数がない場合
                        If UBound(typTorikomi.RyouHen) <= 1 Then
                            strBuff = "' "
                        End If
                            
'                        End If
                    ElseIf .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_CHOSEI Then
                    '計算書(調整資産)
                        
'------------<Modify Start azuma 2006/10/26 > -----------------------
                        lngSameCnt = 0
                        strShisanBunrui = .Range(DATASHEET_KEY_START & lngCurRows).Offset(0, 1).Value
                        strShisanCd = .Range(DATASHEET_KEY_START & lngCurRows).Offset(0, 3).Value
                        For lngSisanCnt = 0 To UBound(typTorikomi.Sisan)
                            With typTorikomi
                                If .Sisan(lngSisanCnt, SISANLIST_SHISAN_BUNRUI) = strShisanBunrui And _
                                   .Sisan(lngSisanCnt, SISANLIST_SHISAN_CODE) = strShisanCd Then
                                   lngSameCnt = lngSameCnt + 1
                                End If
                            End With
                        Next lngSisanCnt
                        
                        '同じ資産が複数ある場合"(計算期間)"を表示する。
                        If lngSameCnt <= 1 Then
                            strBuff = "' "
                        End If
'------------<Modify End   azuma 2006/10/26 > -----------------------
                    
'------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
                    ElseIf .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_G_OYA_SANTEI _
                        Or .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_G_KISO_SUCHI1 _
                        Or .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_G_KISO_SUCHI2 Then
                        
                        '
                        strKikan = CStr(.Range(DATASHEET_RESULT_COL & lngCurRows).Value)
                        If strKikan = "0" Or Trim(strKikan) = "" Then
                            strBuff = "''"
                        Else
                            lngKikan = CLng(strKikan)
                            strBuff = "(" & KEISAN_KIKAN & func_ExchMarusuchi(lngKikan) & ")"
                        End If
                        
                        
'------------<Modify End   azuma 2006/11/01 連No.69> -----------------------

'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                    ElseIf .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_N11_KSAN_SHO Then
                        
                        '期間変更回数がない場合
                        If UBound(typTorikomi.RyouHen) <= 1 Then
'------------<Modify Start azuma 2007/04/20 (PH3)> -----------------------
                            strBuff = "''"
'                            strBuff = "' "
'------------<Modify End   azuma 2007/04/20 (PH3)> -----------------------
                        Else
                            strBuff = CStr(lngKikan)
                        End If

'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
                    End If
'------------<Modify Start azuma 2007/04/20 (PH3)> -----------------------
                Case DATASHEET_SEIKYU_ZENTAI_KIKAN_VAL, DATASHEET_N11KEISAN_ZENTAI_KIKAN_VAL     ' 期間"
                '請求書・全体
                    
'                Case DATASHEET_SEIKYU_ZENTAI_KIKAN_VAL      ' 期間"
'                '請求書・全体
'------------<Modify End   azuma 2007/04/20 (PH3)> -----------------------
                    If Trim(.Range(DATASHEET_OFFSET_COL & lngCurRows).Value) = "" Then
                        strBuff = "'"
                    ElseIf IsNumeric(.Range(DATASHEET_OFFSET_COL & lngCurRows).Value) Then
                        lngKikan = CLng(.Range(DATASHEET_OFFSET_COL & lngCurRows).Value)
'------------<Modify Start azuma 2007/04/20 (PH3)> -----------------------
                        If .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value = DATASHEET_SEIKYU_ZENTAI_KIKAN_VAL Then
                            strBuff = "(" & KEISAN_KIKAN & func_ExchMarusuchi(lngKikan + 1) & ")"
                        ElseIf .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value = DATASHEET_N11KEISAN_ZENTAI_KIKAN_VAL Then
                            strBuff = lngKikan + 1
                        End If
'------------<Modify End   azuma 2007/04/20 (PH3)> -----------------------
                    End If
                    
                    
                    '期間が一つしかない場合は、期間文字を表示しない
                    If UBound(typTorikomi.RyouHen) <= 1 Then
                        strBuff = "'"
                    End If
                    
                Case DATASHEET_SEIKYU_CHOSEI_KIKAN_VAL      ' 期間"
                '請求書・調整資産
                
                    Dim strChoseiKikan      As String

                    strChoseiKikan = .Range(DATASHEET_MULTI1_COL & lngCurRows).Value

                    If Trim(strChoseiKikan) = "" Then
                        strBuff = "'"
                    ElseIf IsNumeric(strChoseiKikan) Then
                        lngKikan = CLng(strChoseiKikan)
                        strBuff = "(" & KEISAN_KIKAN & func_ExchMarusuchi(lngKikan) & ")"
                    End If


'------------<Modify Start azuma 2006/10/26 > -----------------------
                        lngSameCnt = 0
                        strShisanBunrui = .Range(DATASHEET_KEY_START & lngCurRows).Offset(0, 1).Value
                        strShisanCd = .Range(DATASHEET_KEY_START & lngCurRows).Offset(0, 3).Value
                        For lngSisanCnt = 0 To UBound(typTorikomi.Sisan)
                            With typTorikomi
                                If .Sisan(lngSisanCnt, SISANLIST_SHISAN_BUNRUI) = strShisanBunrui And _
                                   .Sisan(lngSisanCnt, SISANLIST_SHISAN_CODE) = strShisanCd Then
                                   lngSameCnt = lngSameCnt + 1
                                End If
                            End With
                        Next lngSisanCnt
                        
                        '同じ資産が複数ある場合"(計算期間)"を表示する。
                        If lngSameCnt <= 1 Then
                            strBuff = "' "
                        End If

''                    '期間が一つしかない場合は、期間文字を表示しない
''                    If typTorikomi.lngChoseSisanId <= 1 Then
''                        strBuff = "'"
''                    End If

'------------<Modify End   azuma 2006/10/26 > -----------------------
                    
                    
                    
                Case DATASHEET_T21_MEISAI_FROM_VAL, DATASHEET_T21_MEISAI_TO_VAL
                'T21明細の期間From,To
'------------<Modify Start azuma 2007/04/12 > -----------------------
'                    Dim lngKikanFromRow     As Long
'                    Dim lngKikanToRow       As Long
                    Dim strKikanFrom        As String
                    Dim strKikanTo          As String
                    Dim lngOffSet           As Long
                    Dim strKikanFromNext    As String
                    
                    '期間Fromの行を求める
                    lngKikanFromRow = .Cells.Find(What:=DATASHEET_T21_MEISAI_KIKAN_FROM_VAL, _
                        After:=.Cells(lngCurRows, DATASHEET_ITEMNAME_COL), LookIn:=xlFormulas, LookAt:=xlWhole, _
                        SearchOrder:=xlByRows, SearchDirection:=xlPrevious).Row
                    '期間From日を取得
                    strKikanFrom = .Range(DATASHEET_RESULT_COL & lngKikanFromRow)
                        
                    '期間Toの行を求める
                    lngKikanToRow = lngKikanFromRow + 1
                    '期間To日を取得
                    strKikanTo = .Range(DATASHEET_RESULT_COL & lngKikanToRow)
                    
                    'カレント行のオフセット値取得
                    lngOffSet = .Range(DATASHEET_OFFSET_COL & lngCurRows)
                    
                    
                    If .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value = DATASHEET_T21_MEISAI_FROM_VAL Then
                    'From日を求める場合
                        Call sub_GetT21FromData(strKikanFrom, lngOffSet, strBuff)
                    Else
                    'To日を求める場合
                        Call sub_GetT21FromData(strKikanFrom, lngOffSet + 1, strKikanFromNext)
                        strBuff = CStr(Format(DateAdd("d", -1, DateSerial(CInt(Mid(strKikanFromNext, 1, 4)), CInt(Mid(strKikanFromNext, 5, 2)), CInt(Mid(strKikanFromNext, 7, 2)))), "YYYYMMDD"))
                        
                        '最終月の帳尻合わせ
                        If strBuff >= CStr(.Range(DATASHEET_RESULT_COL & lngKikanToRow).Value) Then
                            strBuff = Replace(.Range(DATASHEET_RESULT_COL & lngKikanToRow).Value, "/", "")
                        End If
                    End If

''                    Dim dDate As Date
''                    Dim lngOffSet As Long
''''                    Dim lngKikanFromRow As Long
''''                    Dim lngKikanToRow   As Long
''
''                    If .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value = DATASHEET_T21_MEISAI_FROM_VAL Then
''                        lngOffSet = 1
''                    Else
''                        lngOffSet = 2
''                    End If
''
'''------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
''' ※検索時に取得するように変更(Findメソッドのパレメータが他のBookの影響を受ける又は与えるため
'''                    '期間Fromの行を求める
'''                    lngKikanFromRow = .Cells.Find(What:=DATASHEET_T21_MEISAI_KIKAN_FROM_VAL, _
'''                        After:=.Cells(lngCurRows, DATASHEET_ITEMNAME_COL), LookIn:=xlFormulas, LookAt:=xlWhole, _
'''                        SearchOrder:=xlByRows, SearchDirection:=xlPrevious).Row
'''
''''------------<Modify Start azuma 2006/11/17 > -----------------------
'''                    '期間Toの行を求める
'''                    lngKikanToRow = lngKikanFromRow + 1
''''------------<Modify End   azuma 2006/11/17 > -----------------------
'''------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
''
''                    ' 「期間xx年月」の年、月と「期間From」の日付を合わせる
''                    dDate = Mid(.Range(DATASHEET_RESULT_COL & lngCurRows - lngOffSet), 1, 4) & "/" _
''                          & Mid(.Range(DATASHEET_RESULT_COL & lngCurRows - lngOffSet), 5, 2) & "/" _
''                          & Right(.Range(DATASHEET_RESULT_COL & lngKikanFromRow), 2)
''
''                    If .Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value = DATASHEET_T21_MEISAI_FROM_VAL Then
''                        strBuff = Format(DateAdd("m", 0, dDate), "yyyymmdd")
''                    Else
''                        strBuff = Format(DateAdd("m", 1, dDate) - 1, "yyyymmdd")
''
'''------------<Modify Start azuma 2006/11/17 > -----------------------
''                        '期間xxx年月Fromの年月と計算書期間TOの年月が一致したら、期間xxx年月Toを計算書期間TOで表示する。
''                        If Mid(.Range(DATASHEET_RESULT_COL & lngCurRows - 1).Value, 1, 6) = Mid(.Range(DATASHEET_RESULT_COL & lngKikanToRow).Value, 1, 6) Then
''                            strBuff = Replace(.Range(DATASHEET_RESULT_COL & lngKikanToRow).Value, "/", "")
''                        End If
'''                        '最終行だったら("期間xxx年月To"の2行下に"期間xxx年月"がない場合)計算書期間TOを設定する。
'''                        If .Range(DATASHEET_ITEMNAME_COL & lngCurRows + 2).Value <> DATASHEET_T21_MEISAI_NENGETSU_VAL Then
'''                            strBuff = Replace(.Range(DATASHEET_RESULT_COL & lngKikanToRow).Value, "/", "")
'''                        End If
'''------------<Modify End   azuma 2006/11/17 > -----------------------
''
''                    End If
'------------<Modify End   azuma 2007/04/12 > -----------------------
                    
                Case DATASHEET_G_SEIKYU_OYA_KIKAN_VAL   '期間xxx期間
'------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
                    strKikan = CStr(.Range(DATASHEET_RESULT_COL & lngCurRows).Value)
                    If strKikan = "0" Or Trim(strKikan) = "" Then
                        strBuff = "''"
                    Else
                        lngKikan = CLng(strKikan)
                        strBuff = "(" & KEISAN_KIKAN & func_ExchMarusuchi(lngKikan) & ")"
                    End If
'                    If Trim(.Range(DATASHEET_OFFSET_COL & lngCurRows).Value) = "" Then
'                        strBuff = "'"
'                    ElseIf IsNumeric(.Range(DATASHEET_OFFSET_COL & lngCurRows).Value) Then
'                        lngKikan = CLng(.Range(DATASHEET_OFFSET_COL & lngCurRows).Value)
'                        strBuff = "(" & KEISAN_KIKAN & func_ExchMarusuchi(lngKikan + 1) & ")"
'                    End If
'------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
                    
'------------<Modify Start azuma 2006/12/19 (PH2)> -----------------------
                Case DATASHEET_SAITEI_HOSHOH_FLG        '顧問料最低保障有効フラグ
    
'    Dim Result   As TypSaitei
    
                    blnRet = func_SaiteHoshouFlg(strKohzaList() _
                                               , lngKKCnt _
                                               , Result)
                                               
                    If blnRet = False Then
                        With gusrErr
                            .ModuleId = MODULE_NAME         'モージュールID
                            .Procedure = PROCEDURE_NAME     'プロシージャID
                            .MsgCode = ERR_MSGCD_VB         'メッセージ区分
                            .ErrNum = Err.Number            'システムエラーコード
                            .ErrDescript = Err.Description  'システムエラー内容
                            .KohzaNo = strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
                            .MsgNaiyou = "顧問料最低保障フラグ取得失敗"        'メッセージ内容(ブックファイル名)
                            With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
                            gusrErr.MsgSyousai = "顧問料最低保障フラグ取得関数(func_SaiteHoshouFlg）で " & vbCrLf _
                                            & "システムエラーが発生しました。" & vbCrLf _
                                            & "システム管理者に連絡して下さい。" & vbCrLf _
                                            & "口座番号       :" & strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO) & vbCrLf _
                                            & "請求期間ID     :" & strKohzaList(lngKKCnt, KOHZALIST_SEIKYU_KIKAN_ID) & vbCrLf _
                                            & "日付種類　     :" & strKohzaList(lngKKCnt, KOHZALIST_HIZUKE_SHURUI) & vbCrLf _
                                            & "計算TO日　     :" & strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_TO)
                            End With
                            'エラーシート書き込み
                            Call fncWriteErrSheet(ERROR_SHEETNAME)
                            lngErrorCnt = lngErrorCnt + 1
                        End With
                    Else
                        strBuff = Result.strSaiteYukouFlg
                    End If

                Case DATASHEET_NENDO        '年度
                    strBuff = func_GetNendo(strKohzaList(lngKKCnt, KOHZALIST_SEIKYUSHO_KIKAN_FROM))
                
'------------<Modify End   azuma 2006/12/19 (PH2)> -----------------------
                
                
                Case Else
                    strBuff = ""
                End Select
                
                '消費税率
                If Right(Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value, 4) = DATASHEET_SHOUHI_ZEI_VAL Then
                    strBuff = strZeiRitsu
                End If
                
            
            
'------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
                If .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_G_SEIKYU_ZENTAI Then
                    If Right(.Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value, Len(DATASHEET_SEIKYU_ZENTAI_KIKAN_VAL)) = DATASHEET_SEIKYU_ZENTAI_KIKAN_VAL Then
                        strKikan = CStr(.Range(DATASHEET_RESULT_COL & lngCurRows).Value)
                        If strKikan = "0" Or Trim(strKikan) = "" Then
                            strBuff = "''"
                        Else
                            lngKikan = CLng(strKikan)
                            strBuff = "(" & KEISAN_KIKAN & func_ExchMarusuchi(lngKikan) & ")"
                        End If
                    End If
                End If
''------------<Modify Start azuma 2006/10/20 単No.225> -----------------------
'                '合算請求書・全体の「口座01期間xxx運用資産額全体名称」' 期間"
'                If .Range(DATASHEET_SHEETNAME_COL & lngCurRows).Value = DATASHEET_G_SEIKYU_ZENTAI Then
'                    If Right(.Range(DATASHEET_ITEMNAME_COL & lngCurRows).Value, Len(DATASHEET_SEIKYU_ZENTAI_KIKAN_VAL)) = DATASHEET_SEIKYU_ZENTAI_KIKAN_VAL Then
'
'                        If Trim(.Range(DATASHEET_OFFSET_COL & lngCurRows).Value) = "" Then
'                            strBuff = "'"
'                        ElseIf IsNumeric(.Range(DATASHEET_OFFSET_COL & lngCurRows).Value) Then
'                            lngKikan = CLng(Right(.Range(DATASHEET_OFFSET_COL & lngCurRows).Value, 2))
'                            strBuff = "(" & KEISAN_KIKAN & func_ExchMarusuchi(lngKikan + 1) & ")"
'                        End If
'
'
'                        '期間が一つしかない場合は、期間文字を表示しない
'                        If UBound(typTorikomi.RyouHen) <= 1 Then
'                            strBuff = "'"
'                        End If
'                    End If
'                End If
''------------<Modify End   azuma 2006/10/20 単No.225> -----------------------
'------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
                
                '文字列の設定
                If Trim(strBuff) <> "" Then
                    .Range(DATASHEET_RESULT_COL & lngCurRows).Value = strBuff
                End If
                   
            
            
            Case "計算"
                '処理なし
            Case "固定"
                '処理なし
            End Select
            
            
            
'            End If
        
        Next lngCurRows
    
    
        .Columns(DATASHEET_RESULT_COL & ":" & DATASHEET_RESULT_COL).EntireColumn.AutoFit
    
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
        .Columns(DATASHEET_ITEMNAME_COL & ":" & DATASHEET_ITEMNAME_COL).EntireColumn.AutoFit
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
    
    End With
    
    
    Erase vdata
    
    
'------------<Modify Start azuma 2006/11/06 > -----------------------
'''    Set rstRATE_TEKIYOH_KIKAN = Nothing
'''    Set rstKOMONRYOH_SUM = Nothing
'''    Set rstKEISAN_KISO_SUCHI_SUM = Nothing
'''    Set rstVW_SHISAN_JIKA = Nothing
'''    Set rstGOHSEI_RATE = Nothing
'''    Set rstKOMONRYOH_KEISAN_KEKKA = Nothing
'''    Set rstKEISAN_KISO_SUCHI = Nothing
'''    Set rstKOMONRYOH_KEISAN_MEISAI = Nothing
'''    Set rst = Nothing
'''    Set dicTableList = Nothing
'''    Set TableList = Nothing
'------------<Modify End   azuma 2006/11/06 > -----------------------
    
    If lngErrorCnt = 0 Then
    
        func_CompleteDataFile = True
    End If
    
    
    Exit Function
    
ErrHandler:

    func_CompleteDataFile = False
'Resume
'---- Error Log Start ----------------------------------------------------
'    Dim lng As Long
'    lng = Err.Number
'    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "func_CompleteDataFile", Err.Number, Err.Description)
'    On Error GoTo 0
'
    Erase vdata
'    Err.Raise lng
'---- Error Log End   ----------------------------------------------------
    
    With gusrErr
        .ModuleId = MODULE_NAME         'モージュールID
        .Procedure = PROCEDURE_NAME     'プロシージャID
        .MsgCode = ERR_MSGCD_VB         'メッセージ区分
        .ErrNum = Err.Number            'システムエラーコード
        .ErrDescript = Err.Description  'システムエラー内容
        .KohzaNo = strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
        .MsgNaiyou = "データ取得処理システムエラー"        'メッセージ内容(ブックファイル名)
        .MsgSyousai = "データ取得処理でシステムエラーが発生しました。" & vbCrLf _
                    & "システム管理者に連絡して下さい。" & vbCrLf _
                    & "作成中ファイル名       :" & strFileName
        'エラーシート書き込み
        Call fncWriteErrSheet(ERROR_SHEETNAME)
    End With
    lngErrorCnt = lngErrorCnt + 1
    
    
'------------<Modify Start azuma 2006/11/06 > -----------------------
'''    Set rstRATE_TEKIYOH_KIKAN = Nothing
'''    Set rstKOMONRYOH_SUM = Nothing
'''    Set rstKEISAN_KISO_SUCHI_SUM = Nothing
'''    Set rstVW_SHISAN_JIKA = Nothing
'''    Set rstGOHSEI_RATE = Nothing
'''    Set rstKOMONRYOH_KEISAN_KEKKA = Nothing
'''    Set rstKEISAN_KISO_SUCHI = Nothing
'''    Set rstKOMONRYOH_KEISAN_MEISAI = Nothing
'''    Set rst = Nothing
'''    Set dicTableList = Nothing
'''    Set TableList = Nothing
'------------<Modify End   azuma 2006/11/06 > -----------------------

End Function

'
'*************************************************************************
'関数名　　：データシート検索SQL作成
'
'引　　数　：
'           strFileName     I       対象EXCEL名
'           lngCurRows      I       対象行
'           strSql          O       検索SQL
'           strFilter       O       Filter文
'
'戻り値　　：なし
'
'機能説明　：データシートの行毎SQL作成
'
'更新履歴　：2006/08/31 SRA Y.Azuma    新規作成
'更新履歴　：2007/03/29 SRA Y.Azuma    変更     (PH3)PH3請求書作成の対応
'
'*************************************************************************
Private Sub sub_MakeDataSheetSql(ByVal strFileName As String _
                               , ByVal lngCurRows As Long _
                               , ByRef strSql As String _
                               , ByRef strFilter As String)
    
    
    Dim strTableName    As String
    Dim strGetItem      As String
    Dim strKeyItem()    As String
    Dim lngCnt          As Long
    Dim strWhere        As String
    Dim lngItem         As Long
    
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
    Const KEY_ITEM = 8
'    Const KEY_ITEM = 7
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
    lngItem = 0
    strWhere = ""
    
    
    ReDim strKeyItem(KEY_ITEM, 2)
    
    
    With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
    
        strTableName = .Range(DATASHEET_TID_COL & lngCurRows).Text
        strGetItem = .Range(DATASHEET_COLID_COL & lngCurRows).Text
    
        For lngCnt = 0 To KEY_ITEM
            'キー項目
            If Trim(.Range(DATASHEET_KEY_START & lngCurRows).Offset(0, lngCnt * 2).Text) <> "" Then
                strKeyItem(lngItem, 1) = Trim(.Range(DATASHEET_KEY_START & lngCurRows).Offset(0, lngCnt * 2).Text)
                'キー項目値
                strKeyItem(lngItem, 2) = Trim(.Range(DATASHEET_KEY_START & lngCurRows).Offset(0, lngCnt * 2 + 1).Text)
                lngItem = lngItem + 1
            End If
            
        Next lngCnt
    
    End With
    strSql = ""
    strSql = strSql & " SELECT "
    strSql = strSql & "     " & strGetItem
    strSql = strSql & " FROM "
    strSql = strSql & "     " & strTableName
    strSql = strSql & " WHERE "
    
    For lngCnt = 0 To UBound(strKeyItem) 'KEY_ITEM
    
        If Trim(strKeyItem(lngCnt, 1)) <> "" Then
            
            If Trim(strWhere) <> "" Then
                strWhere = strWhere & " AND "
            End If
            
            strWhere = strWhere & strKeyItem(lngCnt, 1) & " = '" & strKeyItem(lngCnt, 2) & "' "
            
        End If
    
    Next lngCnt
    
    strSql = strSql & strWhere
    strFilter = strWhere
    
End Sub

'------------<Modify Start azuma 2006/11/06 > -----------------------
''''*************************************************************************
''''関数名　　：レコードセット取得関数
''''
''''引　　数　：
''''           strTableName        I       テーブル名
''''           strKohzaNo          I       口座番号
''''           strKohzaNoOya       I       親口座番号
''''           strSeikyuKikanId    I       請求期間ID
''''           rstObject           O       レコードセットオブジェクト
''''           strOrderBy          I       ソート順
''''           strAddWhere         I       追加検索条件
''''
''''戻り値　　：
''''
''''機能説明　：
''''
''''更新履歴　：2006/08/25 SRA Y.Azuma    新規作成
''''
''''*************************************************************************
'''Private Function func_CreateRecordset(ByVal strTableName As String _
'''                                    , ByVal strKohzaNo As String _
'''                                    , ByVal strKohzaNoOya As String _
'''                                    , ByVal strSeikyuKikanId As String _
'''                                    , ByRef rstObject As Object _
'''                                    , Optional ByVal strOrderby = "" _
'''                                    , Optional ByVal strAddWhere = "") As Boolean
'''
'''On Error GoTo ErrHandler
'''
'''    Const PROCEDURE_NAME = "func_CreateRecordset"
'''    Dim strSql  As String
'''
'''    func_CreateRecordset = False
'''
'''    strSql = ""
'''    strSql = strSql & " SELECT  *"
'''    strSql = strSql & "   FROM  " & strTableName
'''    If Trim(strKohzaNoOya) = "" Then
'''        strSql = strSql & "  WHERE  KOHZA_NO        = '" & strKohzaNo & "' "
'''        strSql = strSql & "    AND  SEIKYU_KIKAN_ID =  " & strSeikyuKikanId
'''    Else
'''        strSql = strSql & "  WHERE  KOHZA_NO        IN('" & strKohzaNo & "', "
'''        strSql = strSql & "                            '" & strKohzaNoOya & "') "
'''    End If
'''
'''    If strTableName <> "KYK_VW_SHISAN_JIKA" Then
'''        strSql = strSql & "    AND  SAKUJO_FLG      = '0'"
'''    End If
'''
'''    If Trim(strAddWhere) <> "" Then
'''        strSql = strSql & "    " & strAddWhere
'''    End If
'''
'''    If Trim(strOrderby) <> "" Then
'''        strSql = strSql & "  ORDER  BY " & strOrderby
'''    End If
'''
'''    rstObject.Open strSql, cnAdo, adOpenKeyset, adLockReadOnly, adCmdText
''''    rstObject.Open strSql, cnAdo, adOpenStatic, adLockReadOnly, adCmdText
'''
'''
'''    func_CreateRecordset = True
'''
'''    Exit Function
'''
'''ErrHandler:
'''
'''    func_CreateRecordset = False
''''---- Error Log Start ----------------------------------------------------
'''    Dim lng As Long
'''    lng = Err.Number
'''    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "func_CreateRecordset", Err.Number, Err.Description)
'''    On Error GoTo 0
''''---- Error Log End   ----------------------------------------------------
'''
'''End Function
'------------<Modify End   azuma 2006/11/06 > -----------------------


'------------<Modify Start azuma 2006/10/25 連No.54> -----------------------
''''*************************************************************************
''''関数名　　：データシート行増幅関数
''''
''''引　　数　：
''''           strGassanKbn    I       合算口座区分
''''           strSyoruiOut()  O       出力書類一覧
''''
''''戻り値　　：なし
''''
''''機能説明　：書類送付のご案内に出力する書類一覧を作成する。
''''
''''更新履歴　：2006/10/10 SRA Y.Azuma    新規作成
''''
''''*************************************************************************
'''Private Sub sub_Syorui2(ByVal strGassanKbn As String, ByRef strSyoruiOut() As String)
'''
'''    Dim lngKohzaCnt         As Long
'''    Dim lngShorui           As Long
'''    Dim lngCnt              As Long
'''    Dim varShoruiList       As Variant
'''    Dim strName             As String
'''    Dim strBuff             As String
'''    Dim strSyoruiWork()     As String
'''    Dim lngWorkCnt          As Long
'''    Dim blnSeikyushoFlg     As Boolean
'''    Dim dicList             As Variant
'''
'''    Set dicList = CreateObject("Scripting.Dictionary")
'''
'''
'''    lngWorkCnt = 0
'''    ReDim strSyoruiWork(0)
'''    blnSeikyushoFlg = False
'''
'''    'このリストの順番が案内の出力順になる。
'''    varShoruiList = Array( _
'''                          DATASHEET_G_SEKYUU _
'''                        , DATASHEET_GOHKEI _
'''                        , DATASHEET_G_OYA_KEISAN _
'''                        , DATASHEET_ZENTAI _
'''                        , DATASHEET_CHOSEI _
'''                        , DATASHEET_T21SISAN _
'''                        , DATASHEET_G_OYA_SANTEI _
'''                        , DATASHEET_G_KISO_SUCHI2 _
'''                        , DATASHEET_G_KISO_SUCHI1 _
'''                        , DATASHEET_KISO_SUCHI1 _
'''                        , DATASHEET_KISO_SUCHI2 _
'''                        , DATASHEET_GOHSEI _
'''                        , DATASHEET_TOKUKA_GATA _
'''                        , DATASHEET_T21_MEISAI _
'''                      )
'''
'''
'''
'''    For lngKohzaCnt = 1 To UBound(typSakuseiSyorui)
'''
'''        dicList.RemoveAll
'''
'''        For lngShorui = 0 To UBound(varShoruiList)
'''
'''            For lngCnt = 0 To typSakuseiSyorui(lngKohzaCnt).lngListCnt
'''
'''                If varShoruiList(lngShorui) = typSakuseiSyorui(lngKohzaCnt).strShoruiList(lngCnt) Then
'''
'''                    '出力する書類名を見つけ)
'''                    Select Case varShoruiList(lngShorui)
'''                        Case DATASHEET_G_SEKYUU '合算請求書
'''                            If blnSeikyushoFlg = False Then
'''                                strName = "投資顧問料(合算請求書)"
'''                                blnSeikyushoFlg = True
'''                            Else
'''                                strName = ""
'''                            End If
'''
'''                        Case DATASHEET_GOHKEI '請求書
'''                            If blnSeikyushoFlg = False Then
'''                                strName = "投資顧問料(請求書)"
'''                                blnSeikyushoFlg = True
'''                            Else
'''                                strName = ""
'''                            End If
'''
'''                        Case DATASHEET_G_OYA_KEISAN '親口座計算書
'''                            strName = "投資顧問料計算書(親口座全体)"
'''
'''                        Case DATASHEET_ZENTAI '総計算書
'''                            strName = "投資顧問料計算書(資産全体)"
'''
'''                        Case DATASHEET_CHOSEI '計算書
'''                            strName = "投資顧問料計算書(調整資産+/-)"
'''
'''                        Case DATASHEET_T21SISAN '自己設定投信
'''                            strName = "自己設定投信委託者報酬額明細"
'''
'''                        Case DATASHEET_G_OYA_SANTEI '親算定基礎
'''                            strName = "投資顧問料算定基礎(親口座)"
'''
'''                        Case DATASHEET_G_KISO_SUCHI2 '月末時価平残
'''                            strName = "投資顧問料算定基礎(子口座　月末・前月末)"
'''
'''                        Case DATASHEET_G_KISO_SUCHI1 '月中時価平残
'''                            strName = "投資顧問料算定基礎(子口座　月中・前月中)"
'''
'''                        Case DATASHEET_KISO_SUCHI1 '月末算定基礎
'''                            strName = "投資顧問料算定基礎(月末・前月末)"
'''
'''                        Case DATASHEET_KISO_SUCHI2 '月中算定基礎
'''                            strName = "投資顧問料算定基礎(月中・前月中)"
'''
'''                        Case DATASHEET_GOHSEI '合成料率
'''                            strName = "合成料率案内書"
'''
'''                        Case DATASHEET_TOKUKA_GATA '料率
'''                            strName = "資産別特化型料率"
'''
'''                        Case DATASHEET_T21_MEISAI 'T21明細
'''                            strName = "T21調整資産明細"
'''                        Case Else
'''                            strName = ""
'''                    End Select
'''
'''                    '以下の書類は、口座番号を頭に付加する。
'''                    '　投資顧問料計算書(調整資産+/-) ,自己設定投信,T21明細
'''                    If varShoruiList(lngShorui) = DATASHEET_CHOSEI Or _
'''                       varShoruiList(lngShorui) = DATASHEET_T21SISAN Or _
'''                       varShoruiList(lngShorui) = DATASHEET_T21_MEISAI Or _
'''                       varShoruiList(lngShorui) = DATASHEET_G_KISO_SUCHI2 Or _
'''                       varShoruiList(lngShorui) = DATASHEET_G_KISO_SUCHI1 Then
'''
'''                       If strGassanKbn = KOHZA_GASSAN_ON Then
'''                            strBuff = "(" & typSakuseiSyorui(lngKohzaCnt).strKhozaNo & ")" & strName
'''                        Else
'''                            strBuff = strName
'''                        End If
'''                    Else
'''                        strBuff = strName
'''                    End If
'''
'''
'''                    If Trim(strBuff) <> "" Then
'''
'''                        If dicList.exists(strBuff) = False Then
'''                            dicList.Add strBuff, strBuff
'''
'''                            ReDim Preserve strSyoruiWork(lngWorkCnt)
'''
'''                            strSyoruiWork(lngWorkCnt) = strBuff
'''
'''                            lngWorkCnt = lngWorkCnt + 1
'''                        End If
'''                    End If
'''
'''
'''
'''                    Exit For
'''                End If
'''            Next lngCnt
'''
'''        Next lngShorui
'''
'''
'''    Next lngKohzaCnt
'''
'''
'''    ReDim strSyoruiOut(lngWorkCnt, 0)
'''
'''    '案内
''''    strSyoruiOut(0, 0) = "書類送付のご案内"
'''
'''    For lngCnt = 0 To lngWorkCnt - 1
'''        strSyoruiOut(lngCnt, 0) = StrConv(CStr(lngCnt + 1), vbWide) & "．" & strSyoruiWork(lngCnt)
'''    Next lngCnt
'''
'''
'''    '支払指図書
'''    strSyoruiOut(lngWorkCnt, 0) = StrConv(CStr(lngWorkCnt + 1), vbWide) & "．" & "投資顧問料支払指図書"
'''
'''
'''    Erase varShoruiList
'''    Erase strSyoruiWork
'''    Set dicList = Nothing
'''End Sub
'------------<Modify End   azuma 2006/10/25 連No.54> -----------------------



'*************************************************************************
'関数名　　：データシート行増幅関数
'
'引　　数　：
'           strFileName     I       処理対象シート名
'           lngStartRow     I       検索開始行
'           lngEndRow       I       検索終了行
'           strSearchName   I       検索文字
'           strData()       I       「データ項目」設定データ
'           lngOffSet       I       任意開始行数
'           strSheetName    I       作成シート名
'
'戻り値　　：なし
'
'機能説明　：データシート行増幅関数
'
'
'更新履歴　：2006/09/07 SRA Y.Azuma    新規作成
'更新履歴　：2007/03/29 SRA Y.Azuma    変更     (PH3)PH3請求書作成の対応
'更新履歴　：2007/04/20 SRA Y.Azuma    変更     (PH3)単体障害対応
'更新履歴　：2007/06/21 SRA Y.Azuma    変更     (PH3)総合　10段階以上の料率段階　No.14
'更新履歴　：2007/07/31 SRA Y.Azuma    変更     (PH3.5)PH3.5機能追加
'更新履歴　：2009/12/16 SRA T.Mizutani 変更     顧客指定B請求書のテンプレート変更
'
'*************************************************************************
Public Sub sub_RowIncrement(ByVal strFileName As String _
                           , ByVal lngStartRow As Long _
                           , ByVal lngEndRow As Long _
                           , ByVal strSearchName As String _
                           , ByRef strData() As String _
                           , Optional ByVal lngOffSet As Long = 0 _
                           , Optional ByVal strSheetName As String = "")
                           
On Error GoTo ErrHandler

    Const PROCEDURE_NAME = "sub_RowIncrement"
    
    Dim lngRowIncCnt        As Long
    Dim lngCopyStartRow     As Long
    Dim lngCopyEndRow       As Long
    Dim lngSearchCnt        As Long
    Dim valRet              As Variant
    Dim lngDataCnt          As Long
    Dim lngPastRow          As Long
    
    lngCopyStartRow = 65536 'lngEndRow
    lngCopyEndRow = lngStartRow
    
    With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
        'コピーする行の開始終了を求める
        For lngSearchCnt = lngStartRow To 65536 'lngEndRow
            If Trim(.Range(DATASHEET_ITEMNAME_COL & lngSearchCnt).Text) <> "" Then
                valRet = InStr(CStr(.Range(DATASHEET_ITEMNAME_COL & lngSearchCnt).Text), strSearchName)
                If IsNull(valRet) = False Then
                    If Trim(valRet) <> "" And Trim(valRet) <> "0" And lngCopyStartRow > lngSearchCnt Then
                        lngCopyStartRow = lngSearchCnt
                    End If
                    
                    If Trim(valRet) > 0 Then
                        lngCopyEndRow = lngSearchCnt
                    End If
                End If
            Else
                Exit For
            End If
            
        Next lngSearchCnt
        
        lngPastRow = lngCopyStartRow
        '設定データ数分、行をコピーして増やす
        For lngRowIncCnt = 0 To UBound(strData)
        
'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------

            'N11計算書 10行以上行までしか増幅しない
            If (strSheetName = (DATASHEET_N11_KSAN_SHO & DATASHEET_KSAN_SHO_SISAN1_DAN) Or _
                strSheetName = (DATASHEET_N11_KSAN_SHO & DATASHEET_KSAN_SHO_SISAN2_DAN) Or _
                strSheetName = (DATASHEET_N11_KSAN_SHO & DATASHEET_KSAN_SHO_SISAN3_DAN) Or _
                strSheetName = (DATASHEET_N11_KSAN_SHO & DATASHEET_KSAN_SHO_SISAN4_DAN)) _
            And lngRowIncCnt > 9 Then
                Exit For
            End If

            '顧客指定Ａ計算書　10行までしか増幅しない
            If (strSheetName = (DATASHEET_A_KSAN_SHO & DATASHEET_KSAN_SHO_SISAN1_DAN) Or _
                strSheetName = (DATASHEET_A_KSAN_SHO & DATASHEET_KSAN_SHO_SISAN2_DAN) Or _
                strSheetName = (DATASHEET_A_KSAN_SHO & DATASHEET_KSAN_SHO_SISAN3_DAN) Or _
                strSheetName = (DATASHEET_A_KSAN_SHO & DATASHEET_KSAN_SHO_SISAN4_DAN)) _
            And lngRowIncCnt > 9 Then
                Exit For
            End If
            
'------------<Modify Start T.Mizutani 2009/12/16 (顧客指定請求書Bのテンプレート変更(増幅の制限をやめる) )> --------
'            '顧客指定B計算書　6行までしか増幅しない
'            If (strSheetName = DATASHEET_B_KSAN_SHO_KISO_SUCHI Or _
'                strSheetName = DATASHEET_B_KSAN_SHO_RATE_DAN) _
'            And lngRowIncCnt > 5 Then
'                Exit For
'            End If
'------------<Modify End T.Mizutani 2009/12/16> -----------

            
''------------<Modify Start azuma 2007/06/21 (PH3)> -----------------------
'            'N11計算書
'            If (strSheetName = DATASHEET_N11_KSAN_SHO_SISAN1_DAN Or _
'                strSheetName = DATASHEET_N11_KSAN_SHO_SISAN2_DAN Or _
'                strSheetName = DATASHEET_N11_KSAN_SHO_SISAN3_DAN Or _
'                strSheetName = DATASHEET_N11_KSAN_SHO_SISAN4_DAN) _
'            And lngRowIncCnt > 9 Then
'                Exit For
'            End If
''------------<Modify End   azuma 2007/06/21 (PH3)> -----------------------
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
        
            
            '行コピー＆ペースト
            If lngRowIncCnt > 0 Then
                .Rows(lngCopyStartRow & ":" & lngCopyEndRow).Copy
                lngPastRow = lngCopyEndRow + 1 + ((lngRowIncCnt - 1) * (lngCopyEndRow - lngCopyStartRow + 1))
                .Rows(lngPastRow & ":" & lngPastRow).Insert Shift:=xlDown
                .Range(DATASHEET_RESULT_COL & lngPastRow & ":" & DATASHEET_OFFSET_COL & (lngPastRow + (lngCopyEndRow - lngCopyStartRow + 1))).Value = ""
            End If
            
            '「データ項目」と「行数」に値設定
            For lngDataCnt = 0 To (lngCopyEndRow - lngCopyStartRow) 'UBound(strData, 1) - 1
'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                
                '「投資資産内訳書」の料率段階表示
                If strSearchName = DATASHEET_INC_RATE_DANKAI & DATASHEET_INC_XX Then
                    .Range(DATASHEET_RESULT_COL & (lngDataCnt + lngPastRow)).Value = strData(lngRowIncCnt, lngDataCnt)
'------------<Modify Start azuma 2007/04/20 (PH3)> -----------------------

'------------<Modify Start azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                '「日次料率段階」の料率段階表示
                ElseIf strSearchName = DATASHEET_INC_NICHIJI_RATE_DANKAI & DATASHEET_INC_XX Then
                    If lngDataCnt = 0 Then
                        .Range(DATASHEET_RESULT_COL & (lngDataCnt + lngPastRow)).Value = strData(lngRowIncCnt, 0)   '料率文字列
                    ElseIf lngDataCnt = 1 Then
                        .Range(DATASHEET_RESULT_COL & (lngDataCnt + lngPastRow)).Value = strData(lngRowIncCnt, 2)   '料率(税抜)
                    End If
'------------<Modify End   azuma 2007/07/31 (PH3.5)> ★★★☆-----------------------
                Else
                
                    .Range(DATASHEET_KEYEND_COL & (lngDataCnt + lngPastRow)).Value = strData(lngRowIncCnt, 0)
                End If
'                End If
'
'                .Range(DATASHEET_KEYEND_COL & (lngDataCnt + lngPastRow)).Value = strData(lngRowIncCnt, 0)
'------------<Modify End   azuma 2007/04/20 (PH3)> -----------------------
'                If strSearchName = DATASHEET_INC_SHORUI & DATASHEET_INC_XX & DATASHEET_ANNAI_SYORUI_VAL Then
'                    .Range(DATASHEET_RESULT_COL & (lngDataCnt + lngPastRow)).Value = strData(lngRowIncCnt, 0)
'                Else
'                    .Range(DATASHEET_KEYEND_COL & (lngDataCnt + lngPastRow)).Value = strData(lngRowIncCnt, 0)
'                End If
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------


'------------<Modify Start azuma 2007/03/29 (PH3)> -----------------------
                If lngOffSet >= 0 Then
                    .Range(DATASHEET_OFFSET_COL & (lngDataCnt + lngPastRow)).Value = lngRowIncCnt + lngOffSet
                Else
                '任意開始行数が負の場合、行数に値を設定しない
                    .Range(DATASHEET_OFFSET_COL & (lngDataCnt + lngPastRow)).Value = ""
                End If
'                .Range(DATASHEET_OFFSET_COL & (lngDataCnt + lngPastRow)).Value = lngRowIncCnt
'------------<Modify End   azuma 2007/03/29 (PH3)> -----------------------
            Next lngDataCnt
        
        Next lngRowIncCnt
    
    End With

    Set valRet = Nothing

    Exit Sub

ErrHandler:

'---- Error Log Start ----------------------------------------------------
    Dim lng As Long
    lng = Err.Number
'Resume
    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "sub_RowIncrement", Err.Number, Err.Description)
    On Error GoTo 0
'    Err.Raise lng
'---- Error Log End   ----------------------------------------------------
    Set valRet = Nothing

End Sub

'指定された範囲行の「行数」列に指定された値を設定する
Public Sub sub_SetGyouNo(ByVal strFileName As String _
                           , ByVal lngStartRow As Long _
                           , ByVal lngEndRow As Long _
                           , ByVal lngNo As Long)
    Dim lngRow As Long
    
    For lngRow = lngStartRow To lngEndRow
        With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
            .Range(DATASHEET_OFFSET_COL & lngRow).Value = lngNo
        End With
    Next lngRow
                           
End Sub
                           







'*************************************************************************
'関数名　　：消費税率取得関数
'
'引　　数　：
'           strKohzaList()  I       処理対象口座配列配列
'           lngKKCnt        I       処理対象口座配列配列の添え字
'
'戻り値　　：消費税率
'
'機能説明　：税率テーブルから現在の消費税率を取得する。
'
'更新履歴　：2006/09/11 SRA Y.Azuma    新規作成
'更新履歴　：2007/04/17 SRA Y.Azuma    変更     (PH3)消費税率取得方法の統一
'更新履歴　：2007/12/06 SRA Y.Azuma    変更     (PH4)PH4対応
'
'*************************************************************************
Private Function func_GetShouhiZei(ByRef strKohzaList() As String _
                                 , ByVal lngKKCnt As Long) As String
On Error GoTo ErrHandler

    Const PROCEDURE_NAME = "func_GetShouhiZei"

    Dim strSql      As String
    Dim vdata()     As Variant
    Dim lngCol      As Long
    Dim lngRow      As Long
    Dim strKijunDay As String   '<------------ Modify azuma 2007/04/17
    
    func_GetShouhiZei = ""

'*******************************************************
'* 関数開始　                                        　*
'*******************************************************

'------------<Modify Start azuma 2007/04/17 (PH3)> -----------------------
    '基準日として「請求書期間From」を使う
    strKijunDay = strKohzaList(0, KOHZALIST_SEIKYUSHO_KIKAN_FROM)
'------------<Modify End   azuma 2007/04/17 (PH3)> -----------------------

'------------<Modify Start azuma 2007/12/06 (PH4)> ★★★☆-----------------------
'''''------------<Modify End   azuma 2007/12/06 (PH4)> ★★★☆-----------------------
''''    strSql = ""
''''    strSql = strSql & " SELECT SHOUHI_ZEI"
''''    strSql = strSql & "   FROM SHOUHI_ZEI"
''''    strSql = strSql & "  WHERE KIJYUN_YMD = "
''''    strSql = strSql & " (SELECT MAX(KIJYUN_YMD)"
''''    strSql = strSql & "    FROM SHOUHI_ZEI"
'''''------------<Modify Start azuma 2007/04/17 (PH3)> -----------------------
''''    strSql = strSql & "   WHERE KIJYUN_YMD <= TO_NUMBER(TO_CHAR('" & strKijunDay & "')))"
'''''    strSql = strSql & "   WHERE KIJYUN_YMD <= TO_NUMBER(TO_CHAR(SYSDATE,'YYYYMMDD')))"
'''''------------<Modify End   azuma 2007/04/17 (PH3)> -----------------------

    strSql = ""
    strSql = strSql & " SELECT ZEI"
    strSql = strSql & "   FROM KYK_SHOHIZEI"
    strSql = strSql & "  WHERE TEKIYOH_KIKAN_FROM <= " & strKijunDay
    strSql = strSql & "    AND TEKIYOH_KIKAN_TO   >= " & strKijunDay
'------------<Modify End   azuma 2007/12/06 (PH4)> ★★★☆-----------------------
    
    'データ取得
    Call gclsDB.DoExequteSql(gcSELECT, strSql, vdata, lngCol, lngRow)
    
    
    If lngRow = 0 Then
    'データなし
        func_GetShouhiZei = ""
        Erase vdata
        Exit Function
    Else
    'データあり
        func_GetShouhiZei = CStr(vdata(0, 0))
    End If

    Erase vdata
    Exit Function

ErrHandler:

    func_GetShouhiZei = ""
'Debug.Print strSql
'---- Error Log Start ----------------------------------------------------
    Dim lng As Long
    lng = Err.Number
    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "func_GetShouhiZei ", Err.Number, Err.Description)
    On Error GoTo 0
    Erase vdata
'    Err.Raise lng
'---- Error Log End   ----------------------------------------------------

End Function

'*************************************************************************
'関数名　　：データソート処理
'
'引　　数　：
'           strFileName       I       処理対象ブック
'
'戻り値　　：なし
'
'機能説明　：
'
'更新履歴　：2006/09/12 SRA Y.Azuma    新規作成
'
'*************************************************************************
Private Sub sub_SortDataSheet(ByVal strFileName As String)
    Dim lngEnd  As Long
        
    lngEnd = func_GetEndRow(strFileName, DATASHEET_DATA)
    
    With Workbooks(strFileName).Worksheets(DATASHEET_DATA)
        .Range("1:" & lngEnd).Sort Key1:=Range("A2"), Order1:=xlAscending _
                     , Key2:=Range("B2"), Order2:=xlAscending _
                     , Key3:=Range("G2"), Order3:=xlAscending _
                     , Header:=xlNo, OrderCustom:=1 _
                     , MatchCase:=False, Orientation:=xlTopToBottom _
                     , SortMethod:=xlPinYin
    End With
End Sub

'*************************************************************************
'関数名　　：合算口座の親口座分データシート作成
'
'引　　数　：
'           SisanOya        I       検索結果の配列
'           strOutputDir    I       出力先フォルダ
'           strFileName     I       データファイル名(Pathなし)
'           strKohzaList()  I       処理対象口座配列配列
'           lngKKCnt        I       処理対象口座配列配列の添え字
'           typKohzaList()  I       合算口座構造体
'           lngKohzaCnt     I       合算口座構造体の添え字
'           typTorikomi     O       料率変更構造体
'           lngErrorCnt     O       エラー数
'
'戻り値　　：
'
'機能説明　：親口座の期間数分ループ処理でのみ作成されるデータシートを作成する。
'
'更新履歴　：2006/09/22 SRA Y.Azuma    新規作成
'更新履歴　：2007/06/12 SRA Y.Azuma    変更     (PH3)連結　親算定基礎の明細未作成　障害53
'
'*************************************************************************
Private Function func_DataFileCustomizeOya(ByRef SisanOya() As Variant _
                                      , ByVal strOutputDir As String _
                                      , ByVal strFileName As String _
                                      , ByRef strKohzaList() As String _
                                      , ByVal lngKKCnt As Long _
                                      , ByRef typKohzaList() As typKohzaMain _
                                      , ByVal lngKohzaCnt As Long _
                                      , ByRef typTorikomi As TorikomiOutput _
                                      , ByRef lngErrorCnt As Long) As Boolean

On Error GoTo ErrHandler
    
    Const PROCEDURE_NAME = "func_DataFileCustomizeOya"
   
    Dim lngSisan            As Long         'カウンタ(資産数)
    Dim lngRateMdfSeq       As Long         '料率変更順No    (一般資産)
    Dim strRateTekiyoFrom   As String       '料率適用期間From(一般資産)
    Dim strRateTekiyoTo     As String       '料率適用期間To  (一般資産)
    Dim lngSisanCount       As Long         '料率期間あたりの資産カウント(一般資産)
    
    Dim lngStartRow         As Long         '追加した行の始まり
    Dim lngEndRow           As Long         '追加した行の終わり
'    Dim strSyorui()         As String       '書類名の一覧を格納
    Dim strMsgSyousai       As String       'エラー詳細用
    Dim strGassanKbn        As String       '合算区分(1:合算対象　0:合算対象ではない)
    Dim lngStart            As Long
    Dim lngStartOya         As Long
    Dim lngEnd              As Long
    
    Dim blnRet              As Boolean
    Dim strKikanNo          As String
    
    Dim lngLocalKohzaCnt    As Long
    Dim lngStartKohza       As Long
    
    func_DataFileCustomizeOya = False
    
    lngRateMdfSeq = 0
    lngSisanCount = 0
    
    ReDim strDummy(0, 0)
    
    strRateTekiyoFrom = ""
    strRateTekiyoTo = ""
    strMsgSyousai = ""
    
'*******************************************************
'* 関数開始　                                        　*
'*******************************************************

    ThisWorkbook.Application.ScreenUpdating = False
    
    '合算区分の設定
    strGassanKbn = typKohzaList(lngKohzaCnt).GassanTaishohKbn

'    '請求書(書類)の配列設定
'    Call sub_Syorui(strSyorui())

    '貼付前の最終行を取得
    lngStart = func_GetEndRow(strFileName, DATASHEET_DATA)

    'データシートカスタマイズ
        
    '「合算請求書」の貼付　　※合算口座で1回のみ処理される
    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    If lngKKCnt = 1 Then
        
        '「合算請求書」の貼付　　※合算口座で1回のみ処理される
        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
            '貼付前の最終行を取得
            lngStartOya = func_GetEndRow(strFileName, DATASHEET_DATA)
            
            strMsgSyousai = DATASHEET_G_SEKYUU
            Call sub_AddSheetItemRow(strFileName _
                                   , DATASHEET_G_SEKYUU _
                                   , lngKKCnt _
                                   , "" _
                                   , "" _
                                   , "" _
                                   , lngStartRow _
                                   , lngEndRow)
            lngEnd = func_GetEndRow(strFileName, DATASHEET_DATA)
            
            '*** ()で囲まれた文字列の置換
            Call sub_ReplaceKeyItem(strFileName, strKohzaList(), 0, lngStartOya + 1, lngEnd)
            
        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    
    
    
        '＠合算親口座の期間数でループ
        For lngSisan = 0 To UBound(SisanOya)
    
            '料率変更の回数をカウント
            lngSisanCount = lngSisanCount + 1
            
    '------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
            If strGassanKbn = KOHZA_GASSAN_ON Then
                strKikanNo = ""
                blnRet = False
                '合算の計算期間Noの設定
                blnRet = func_GKeisanKikan(CStr(SisanOya(lngSisan, 2)) _
                                         , CStr(SisanOya(lngSisan, 3)) _
                                         , SisanOya() _
                                         , strKikanNo)
                If blnRet = False Then
                    Exit Function
                End If
            End If
    '------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
            
            If CStr(SisanOya(lngSisan, 0)) = "0" And _
               (CStr(SisanOya(lngSisan, 2)) <> strRateTekiyoFrom Or _
                CStr(SisanOya(lngSisan, 3)) <> strRateTekiyoTo) Then
    
    '            lngSisanCount = 1
    
                lngRateMdfSeq = lngRateMdfSeq + 1
            
    '            If lngKKCnt = 1 Then
                    '貼付前の最終行を取得
                    lngStartOya = func_GetEndRow(strFileName, DATASHEET_DATA)
                    
                    '合算請求書・親口座全体     ※合算口座の期間数分貼り付け
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    strMsgSyousai = DATASHEET_G_SEIKYU_OYA
                    Call sub_AddSheetItemRow(strFileName _
                                           , DATASHEET_G_SEIKYU_OYA _
                                           , lngKKCnt _
                                           , "" _
                                           , "" _
                                           , CStr(lngRateMdfSeq - 1) _
                                           , lngStartRow _
                                           , lngEndRow)
    
    '------------<Modify Start azuma 2006/11/01 連No.69> -----------------------
                    'MULTI項目へ期間の貼付
                    Call sub_FillinMultItem(strFileName _
                                           , DATASHEET_DATA _
                                           , lngStartRow + 1 _
                                           , lngStartRow + 1 _
                                           , DATASHEET_RESULT_COL _
                                           , strKikanNo)
    '------------<Modify End   azuma 2006/11/01 連No.69> -----------------------
                    
                    '条件への貼付け
                    Call sub_SetJoukenData(strFileName _
                                         , SisanOya() _
                                         , lngSisan _
                                         , lngStartRow _
                                         , True)
                                         
                    lngEnd = func_GetEndRow(strFileName, DATASHEET_DATA)
                    
                    '*** ()で囲まれた文字列の置換
                    Call sub_ReplaceKeyItem(strFileName, strKohzaList(), 0, lngStartOya + 1, lngEnd)
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
'------------<Modify Start azuma 2006/11/08 連No.91> -----------------------
                    If lngKKCnt = 1 Then
                    
                        For lngLocalKohzaCnt = 1 To UBound(strKohzaList)
                        
                        '貼付前の最終行を取得
                        lngStartKohza = func_GetEndRow(strFileName, DATASHEET_DATA)
                        
                        '「親口座計算書・口座」の貼付
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                            Call sub_AddSheetItemRow(strFileName _
                                                   , DATASHEET_G_OYA_KEISAN_KOHZA _
                                                   , lngKKCnt _
                                                   , DATASHEET_INC_KIKAN & DATASHEET_INC_XXX _
                                                   , DATASHEET_INC_KIKAN & Format(strKikanNo, "000") _
                                                   , CStr(lngLocalKohzaCnt - 1) _
                                                   , lngStartRow _
                                                   , lngEndRow)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                                                   
                        '「親算定基礎・口座」の貼付
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                            Call sub_AddSheetItemRow(strFileName _
                                                   , DATASHEET_G_OYA_SANTEI_KOHZA _
                                                   , lngKKCnt _
                                                   , DATASHEET_INC_KIKAN & DATASHEET_INC_XXX _
                                                   , DATASHEET_INC_KIKAN & Format(strKikanNo, "000") _
                                                   , CStr(lngLocalKohzaCnt - 1) _
                                                   , lngStartRow _
                                                   , lngEndRow)
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                            '条件への貼付け
                            Call sub_SetJoukenData(strFileName, SisanOya(), 0, lngStartKohza)
                            lngEndRow = func_GetEndRow(strFileName, DATASHEET_DATA)
                            '*** ()で囲まれた文字列の置換
                            Call sub_ReplaceKeyItem(strFileName, strKohzaList(), lngLocalKohzaCnt, lngStartKohza + 1, lngEndRow)
                        Next lngLocalKohzaCnt
                    
'------------<Modify Start azuma 2007/06/12 (PH3)> -----------------------
                        '親算定基礎
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        strMsgSyousai = DATASHEET_G_OYA_SANTEI
                        If lngSisan <= UBound(SisanOya) Then
                            Call sub_GOyaSantei(strFileName _
                                              , lngRateMdfSeq _
                                              , SisanOya() _
                                              , lngSisan _
                                              , strKohzaList() _
                                              , lngKKCnt _
                                              , lngErrorCnt _
                                              , strKikanNo)

                        End If
                        '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
'------------<Modify End   azuma 2007/06/12 (PH3)> -----------------------
                    
                    
                    
                    End If
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                    
'------------<Modify End   azuma 2006/11/08 連No.91> -----------------------
                    
                    '親計算書
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
                        strMsgSyousai = DATASHEET_ZENTAI
                        Call sub_OyaKeisan(strFileName _
                                          , strKikanNo _
                                          , SisanOya() _
                                          , lngSisan _
                                          , strKohzaList() _
                                          , lngKKCnt _
                                          , lngErrorCnt)
    '                    Call sub_OyaKeisan(strFileName _
    '                                      , lngSisanCount _
    '                                      , SisanOya() _
    '                                      , lngSisan _
    '                                      , strKohzaList() _
    '                                      , lngKKCnt _
    '                                      , lngErrorCnt)
        '                strSyorui(5, 1) = "1"   '書類作成フラグ設定
                    '−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−−
    '            End If
    
                
            
            End If
            
            strRateTekiyoFrom = CStr(SisanOya(lngSisan, 2))
            strRateTekiyoTo = CStr(SisanOya(lngSisan, 3))
            
        Next lngSisan
        
        
        '*** ()で囲まれた文字列の置換
        Call sub_ReplaceKeyItem(strFileName, strKohzaList(), lngKKCnt, lngStart + 1, lngEndRow)
            
    End If
    
    func_DataFileCustomizeOya = True
    Exit Function

ErrHandler:

    func_DataFileCustomizeOya = False
'Resume
    With gusrErr
        .ModuleId = MODULE_NAME         'モージュールID
        .Procedure = PROCEDURE_NAME     'プロシージャID
        .MsgCode = ERR_MSGCD_VB         'メッセージ区分
        .ErrNum = Err.Number            'システムエラーコード
        .ErrDescript = Err.Description  'システムエラー内容
        .KohzaNo = strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO)
        .MsgNaiyou = "合算口座データシート作成中システムエラー発生"        'メッセージ内容(ブックファイル名)
        'メッセージ詳細
        .MsgSyousai = "合算口座の親口座分データシート作成中にシステムエラーが発生しました。" & _
             vbCrLf & "システム管理者に連絡して下さい。" & _
             vbCrLf & "作業中ファイル名   :" & strFileName & _
             vbCrLf & "作成中書類名   :" & strMsgSyousai & _
             vbCrLf & "口座番号       :" & strKohzaList(lngKKCnt, KOHZALIST_KOHZA_NO) & _
             vbCrLf & "請求期間ID     :" & strKohzaList(lngKKCnt, KOHZALIST_SEIKYU_KIKAN_ID) & _
             vbCrLf & "資産分類       :" & SisanOya(lngSisan, 1) & _
             vbCrLf & "資産コード     :" & SisanOya(lngSisan, 2)
        'エラーシート書き込み
        Call fncWriteErrSheet(ERROR_SHEETNAME)
    End With

    lngErrorCnt = lngErrorCnt + 1
'---- Error Log Start ----------------------------------------------------
'    Dim lng As Long
'    lng = Err.Number
'    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "func_DataFileCustomizeOya", Err.Number, Err.Description)
'    On Error GoTo 0
    'ワークブックを閉じる
'    Workbooks(strFileName).Close SaveChanges:=False

'    Err.Raise lng
'---- Error Log End   ----------------------------------------------------


End Function

'*************************************************************************
'関数名　　：データシートに指定された資産の列を追加する。
'
'引　　数　：
'           strbookName     I       対象ブック名
'           strSheetName    I       対象シート名
'           lngStartRow     I       開始行
'           lngEndRow       I       終了行
'           strColName      I       列指定
'           strValue        I       設定値
'
'戻り値　　：
'
'機能説明　：データシートの指定列に任意値を設定する。
'
'更新履歴　：2006/09/27 SRA Y.Azuma    新規作成
'
'*************************************************************************
Public Sub sub_FillinMultItem(ByVal strBookName As String _
                              , ByVal strSheetName As String _
                              , ByRef lngStartRow As Long _
                              , ByRef lngEndRow As Long _
                              , ByRef strColName As String _
                              , ByRef strValue As String _
                              )
    
    Const PROCEDURE_NAME = "sub_FillinMultItem"
    Dim lngRow As Long

        For lngRow = lngStartRow To lngEndRow
            Workbooks(strBookName).Sheets(strSheetName).Range(strColName & lngRow).Value = strValue
        Next lngRow


End Sub


'*************************************************************************
'関数名　　：親口座期間数取得
'
'引　　数　：
'           strKikanFrom    I       料率適用期間From
'           strKikanTo      I       料率適用期間To
'           SisanOya()      I       資産(親)の配列
'           strKikanNo      O       計算期間
'
'戻り値　　：
'
'機能説明　：親口座番号
'
'更新履歴　：2006/11/01 SRA Y.Azuma    新規作成
'
'*************************************************************************
Private Function func_GKeisanKikan(ByVal strKikanFrom As String _
                                 , ByVal strKikanTo As String _
                                 , ByRef SisanOya() As Variant _
                                 , ByRef strKikanNo As String) As Boolean

On Error GoTo ErrHandler

    Dim lngRowCnt   As Long
    Dim strWkFrom   As String
    Dim strWkTo     As String
    
    func_GKeisanKikan = False
    
    strKikanNo = ""
    
'*******************************************************
'* 関数開始　                                        　*
'*******************************************************
    
    '期間が1つしかない場合は期間番号なし
    If UBound(SisanOya) = 0 Then
        strKikanNo = "0"
        func_GKeisanKikan = True
        Exit Function
    End If

    For lngRowCnt = 0 To UBound(SisanOya)
        strWkFrom = CStr(SisanOya(lngRowCnt, 2))
        strWkTo = CStr(SisanOya(lngRowCnt, 3))
        If strWkFrom = strKikanFrom And strWkTo = strKikanTo Then
            strKikanNo = CStr(lngRowCnt + 1)
            Exit For
        End If
    Next lngRowCnt

    '該当なし判定
    If lngRowCnt > UBound(SisanOya) Then
        Exit Function
    End If

    func_GKeisanKikan = True
    Exit Function

ErrHandler:

    func_GKeisanKikan = False
'---- Error Log Start ----------------------------------------------------
    Dim lng As Long
    lng = Err.Number
    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, "func_GKeisanKikan", Err.Number, Err.Description)
    On Error GoTo 0
'---- Error Log End   ----------------------------------------------------

End Function
                            

'*************************************************************************
'関数名　　：T21資産明細の期間FROM取得関数
'
'引　　数　：
'           strKikanFrom    I       T21期間FROM(YYYYMMDD)
'           lngOffSet       I       オフセット値
'           strFromData     O       期間FROM(YYYYMMDD)
'
'戻り値　　：なし
'
'機能説明　：T21資産明細の明細行From日を取得する。
'
'更新履歴　：2007/04/12 SRA Y.Azuma    新規作成
'
'*************************************************************************
Public Sub sub_GetT21FromData(ByRef strKikanFrom As String _
                            , ByRef lngOffSet As Long _
                            , ByRef strFromData As String)
On Error GoTo ErrHandler

    Const PROCEDURE_NAME = "sub_GetT21FromData"

    Dim dtmLastDate     As Date
    Dim strLastDate     As String
    Dim dtmWork         As Date
'*******************************************************
'* 関数開始　                                        　*
'*******************************************************
    
    'T21期間FROM年月の最終日を取得する。
    dtmLastDate = DateSerial(CInt(Mid(strKikanFrom, 1, 4)), CInt(Mid(strKikanFrom, 5, 2)) + 1, 0)
    strLastDate = CStr(Format(dtmLastDate, "YYYYMMDD"))
    
    '最終日の判定
    If strKikanFrom = strLastDate Then
    '最終日
        'T21期間FROM + OffSet月の月末
        dtmWork = DateAdd("m", lngOffSet, DateSerial(CInt(Mid(strLastDate, 1, 4)), CInt(Mid(strLastDate, 5, 2)), 1))
        strFromData = CStr(Format(DateSerial(CInt(Format(dtmWork, "YYYY")), CInt(Format(dtmWork, "MM")) + 1, 0), "YYYYMMDD"))
    Else
    '最終日じゃない
        'T21期間FROM + OffSet月
        strFromData = CStr(Format(DateAdd("m", lngOffSet, DateSerial(CInt(Mid(strKikanFrom, 1, 4)), CInt(Mid(strKikanFrom, 5, 2)), CInt(Mid(strKikanFrom, 7, 2)))), "YYYYMMDD"))
    End If
    
    Exit Sub
ErrHandler:


'---- Error Log Start ----------------------------------------------------
    Dim lng As Long
    lng = Err.Number
    Call subErrProcess(ThisWorkbook.Name & "\" & MODULE_NAME, PROCEDURE_NAME, Err.Number, Err.Description)
    On Error GoTo 0
'---- Error Log End   ----------------------------------------------------


End Sub


